name: auto-confirm-deposits

on:
  schedule:
    - cron: "* * * * *"   # –∫–∞–∂–¥—ã–π 1 –º–∏–Ω
  workflow_dispatch:       # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

concurrency:
  group: auto-confirm-deposits
  cancel-in-progress: true

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    env:
      # –¥–æ–±–∞–≤—å —ç—Ç–∏ —Å–µ–∫—Ä–µ—Ç—ã –≤ GitHub ‚Üí Settings ‚Üí Secrets ‚Üí Actions
      FUNC_URL: ${{ secrets.SUPABASE_FUNC_URL }}   # –Ω–∞–ø—Ä.: https://einpfuegfsilnoiareco.functions.supabase.co/auto-confirm-deposits
      CRON_KEY: ${{ secrets.CRON_KEY }}            # —Ç–æ—Ç –∂–µ, —á—Ç–æ CRON_KEY –≤ Secrets —Ñ—É–Ω–∫—Ü–∏–∏ Supabase

    steps:
      - name: Call edge function (with retry)
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${FUNC_URL:-}" || -z "${CRON_KEY:-}" ]]; then
            echo "FUNC_URL or CRON_KEY is not set"; exit 1
          fi

          # –æ–∫–Ω–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 90 –º–∏–Ω—É—Ç
          FROM=$(( $(date -u +%s%3N) - 90*60*1000 ))

          ATTEMPTS=3
          SLEEP=6
          CODE=0
          BODY=""

          for i in $(seq 1 $ATTEMPTS); do
            echo "üîÑ Attempt $i: ${FUNC_URL}?key=***&from=${FROM}"
            RESP="$(curl -sS -w '\nHTTP:%{http_code}\n' \
              "${FUNC_URL}?key=${CRON_KEY}&from=${FROM}")" || true

            echo "$RESP"
            CODE="$(echo "$RESP" | tail -n1 | sed 's/HTTP://')"
            BODY="$(echo "$RESP" | sed '$d')"

            if [[ "$CODE" == "200" ]]; then
              echo "‚úÖ OK (HTTP 200)"; break
            fi
            if [[ $i -lt $ATTEMPTS ]]; then
              echo "‚è≥ Retry in ${SLEEP}s‚Ä¶"; sleep "$SLEEP"
            fi
          done

          if [[ "$CODE" != "200" ]]; then
            echo "‚ùå Function returned HTTP $CODE"; exit 1
          fi

          # –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –ø–æ–∫–∞–∂–µ–º –ø–æ–ª–µ–∑–Ω—ã–µ –ø–æ–ª—è
          echo "Response body:"
          echo "$BODY"
