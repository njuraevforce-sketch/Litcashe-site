<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Смена пароля — Litcash</title>
  <style>
    :root{ --bg:#0f1115; --bg-2:#0b0e13; --card:#161a22; --muted:#8d96a7; --text:#e6e9ef; --accent:#00eaff; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg-2),var(--bg));color:var(--text);font:15px/1.6 Inter,system-ui;}
    .container{width:min(600px,92vw);margin:0 auto;padding:24px 0}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:20px}
    .input{width:100%;height:44px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:var(--text);padding:0 12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;height:46px;padding:0 18px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg, rgba(0,234,255,.18), rgba(30,136,229,.18));color:white;font-weight:700;cursor:pointer}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:12px}
  </style>
</head>
<body>
  <main class="container">
    <div class="card">
      <h1>Смена пароля</h1>
      <p id="msg" class="muted">Если вы попали сюда из письма — просто введите новый пароль.</p>
      <form id="resetForm" class="grid" style="margin-top:12px">
        <input id="newPass" class="input" type="password" placeholder="Новый пароль" required minlength="6">
        <input id="newPass2" class="input" type="password" placeholder="Повторите новый пароль" required minlength="6">
        <button class="btn" type="submit">Сохранить новый пароль</button>
      </form>
      <p style="margin-top:10px"><a href="login_single.html">Вернуться ко входу</a></p>
    </div>
  </main>

  <!-- Supabase JS + конфиг (как на остальных страницах) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabaseConfig.js"></script>
  <script>
  (function(){
    // Создаём клиент с detectSessionInUrl: true — важно для recovery-ссылки
    var sb = window.supabase.createClient(
      window.SUPABASE_URL,
      window.SUPABASE_ANON_KEY,
      { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
    );
    function $(s){ return document.querySelector(s); }
    var form = $('#resetForm');
    var p1 = $('#newPass'), p2 = $('#newPass2');
    var msg = $('#msg');

    async function ensureRecoverySession(){
      try{
        var r = await sb.auth.getSession();
        if (!r || !r.data || !r.data.session) {
          msg.textContent = 'Откройте эту страницу из письма со сбросом пароля.';
          form.style.display = 'none';
        }
      }catch(_){}
    }

    form.addEventListener('submit', async function(e){
      e.preventDefault();
      if ((p1.value||'').length < 6) { alert('Минимум 6 символов'); return; }
      if (p1.value !== p2.value) { alert('Пароли не совпадают'); return; }
      try{
        var resp = await sb.auth.updateUser({ password: p1.value });
        if (resp && resp.error) throw resp.error;
        alert('Пароль обновлён. Теперь войдите с новым паролем.');
        location.href = 'login_single.html';
      }catch(err){
        alert('Ошибка: ' + (err && err.message ? err.message : err));
      }
    });

    ensureRecoverySession();
  })();
  </script>
</body>
</html>
