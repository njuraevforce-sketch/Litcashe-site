<!doctype html>
<html lang="ru">
<head>

  <!-- Supabase client (hard-wired) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    try {
      window.SUPABASE_URL = 'https://einpfuegfsilnoiareco.supabase.co';
      window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpbnBmdWVnZnNpbG5vaWFyZWNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjM3NzAsImV4cCI6MjA2OTk5OTc3MH0.6wF-8yaV38LrXH6Ptm3KIO34wRklJKbNCVoqIGNKh_w';
      if (!window.supabase) throw new Error('supabase lib not loaded');
      window.sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
      window.SB_READY = true;
    } catch(e) {
      alert('Ошибка инициализации Supabase: ' + e.message);
    }
  </script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Litcash — Единая Админ‑панель</title>
  <style>
    :root{ --bg:#0b0f14; --panel:#11161d; --muted:#7c8794; --text:#e6edf3; --accent:#3ea6ff; --ok:#30d158; --warn:#ffd60a; --bad:#ff453a; --card:#0f1520; }
    html,body{ height:100%; background:var(--bg); color:var(--text); font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; margin:0 }
    a{ color:var(--accent); text-decoration:none }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px }
    .topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px }
    .brand{ font-weight:700; letter-spacing:.3px }
    .authbar{ display:flex; gap:8px; align-items:center }
    .authbar .muted{ color:var(--muted) }
    .btn{ background:#151c25; border:1px solid #1c2430; color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer }
    .btn:hover{ background:#182130 }
    .btn.ok{ border-color:#1f4730; background:#10301d }
    .btn.warn{ border-color:#5b4b10; background:#2a250a }
    .btn.bad{ border-color:#55222a; background:#2a0f13 }
    .btn.ghost{ background:transparent; border-color:#2a3647 }
    .tabs{ display:flex; gap:8px; margin:10px 0 16px }
    .tab{ padding:8px 12px; border-radius:10px; background:#121a24; border:1px solid #223245; cursor:pointer }
    .tab.active{ background:#182130; border-color:#335074 }
    .panel{ background:var(--panel); border:1px solid #1b2330; border-radius:14px; padding:14px; margin-bottom:14px }
    .grid{ display:grid; gap:10px }
    .grid.cols-2{ grid-template-columns: 1fr 1fr }
    .grid.cols-3{ grid-template-columns: 1fr 1fr 1fr }
    .grid.cols-4{ grid-template-columns: repeat(4,1fr) }
    .field{ display:grid; gap:6px }
    .field label{ color:#91a0b3; font-size:12px }
    input, select{ background:#0f1520; border:1px solid #253144; color:var(--text); border-radius:10px; padding:8px 10px; outline:none }
    input:focus, select:focus{ border-color:#3e5f85; }
    .muted{ color:var(--muted) }
    .table-wrap{ overflow:auto; border:1px solid #1b2330; border-radius:10px }
    table{ width:100%; border-collapse:collapse; font-size:13px }
    thead{ background:#0f1520 }
    th,td{ padding:10px; border-bottom:1px solid #1b2330; vertical-align:top }
    tr:hover td{ background:#0e1520 }
    .pill{ padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #223245; background:#101826 }
    .pill.paid{ border-color:#1f4730; background:#0f2219; color:#8ef0b0 }
    .pill.pending{ border-color:#334256; background:#121b28; color:#a6c6ff }
    .pill.rejected{ border-color:#55222a; background:#2a0f13; color:#ff8f8a }
    .right{ text-align:right }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .grow{ flex:1 }
    .hint{ background:#0f1520; border:1px dashed #304055; padding:8px 10px; border-radius:10px; color:#aab6c3 }
    .danger{ color:#ff8f8a }
    .green{ color:#8ef0b0 }
    .card{ background:var(--card); border:1px solid #1b2330; border-radius:12px; padding:12px }
    .drawer{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:flex-end; justify-content:flex-end }
    .drawer.open{ display:flex }
    .drawer .sheet{ width:480px; max-width:92vw; height:100%; overflow:auto; background:#0e141c; border-left:1px solid #1b2330; padding:16px }
    code{ background:#0c1118; border:1px solid #1a222e; padding:2px 6px; border-radius:8px }
    .nowrap{ white-space:nowrap }
  </style>
  <!-- Supabase client (fallback to CDN if window.sb not present) -->
  <script>
    window.SUPABASE_URL = window.SUPABASE_URL || "";
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "";
  </script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">Litcash • Admin</div>
      <div class="authbar">
        <span class="muted">Аккаунт:</span>
        <span id="authInfo" class="nowrap">не авторизованы</span>
        <button class="btn" id="btnLogin">Войти</button>
        <button class="btn" id="btnLogout" style="display:none">Выйти</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="withdrawals">Заявки на вывод</button>
      <button class="tab" data-tab="users">Пользователи</button>
      <button class="tab" data-tab="refs">Рефералы</button>
      <button class="tab" data-tab="about">Настройки / Справка</button>
    </div>

    <!-- WITHDRAWALS -->
    <section class="panel" data-page="withdrawals">
      <div class="row">
        <select id="wStatus">
          <option value="">Все статусы</option>
          <option value="pending">Ожидание</option>
          <option value="paid">Оплачено</option>
          <option value="rejected">Отклонено</option>
        </select>
        <input id="wSearch" class="grow" placeholder="Поиск: id, адрес, TX, email, телефон"/>
        <button class="btn" id="wReload">Обновить</button>
      </div>
      <div class="table-wrap" style="margin-top:10px">
        <table id="wTable">
          <thead><tr>
            <th>ID</th><th>Создано</th><th>Email</th><th>Телефон</th>
            <th class="right">Сумма</th><th>Реквизиты</th><th>Статус</th><th>TX/примечание</th><th></th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:10px">
        <span class="muted" id="wDiag">—</span>
        <span class="grow"></span>
        <button class="btn ghost" id="wPrev">Назад</button>
        <button class="btn ghost" id="wNext">Вперёд</button>
      </div>
    </section>

    <!-- USERS -->
    <section class="panel" data-page="users" style="display:none">
      <div class="row">
        <input id="uSearch" class="grow" placeholder="Поиск: email, телефон, user_id"/>
        <button class="btn" id="uReload">Обновить</button>
        <span class="muted" id="uDiag">—</span>
      </div>
      <div class="table-wrap" style="margin-top:10px">
        <table id="uTable">
          <thead><tr>
            <th>ID</th><th>Создано</th><th>Email</th><th>Телефон</th><th class="right">Баланс</th><th></th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>


    <!-- REFS -->
    <section class="panel" data-page="refs" style="display:none">
      <div class="grid cols-3">
        <div class="card">
          <h3>Общий обзор</h3>
          <div class="row">
            <input id="rUser" class="grow" placeholder="User ID для обзора (или откройте пользователя во вкладке «Пользователи»)">
            <button class="btn" id="rLoad">Показать</button>
          </div>
          <div class="grid cols-3" style="margin-top:10px">
            <div class="field"><label>Поколение 1</label><div class="pill" id="rGen1">—</div></div>
            <div class="field"><label>Поколение 2</label><div class="pill" id="rGen2">—</div></div>
            <div class="field"><label>Поколение 3</label><div class="pill" id="rGen3">—</div></div>
          </div>
          <div class="grid cols-3" style="margin-top:10px">
            <div class="field"><label>Сумма L1</label><div class="pill" id="rSum1">—</div></div>
            <div class="field"><label>Сумма L2</label><div class="pill" id="rSum2">—</div></div>
            <div class="field"><label>Сумма L3</label><div class="pill" id="rSum3">—</div></div>
          </div>
        </div>
        <div class="card">
          <h3>Последние начисления</h3>
          <div class="table-wrap">
            <table id="rLast">
              <thead><tr><th>Дата</th><th>Уровень</th><th>Сумма</th><th>Источник</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <h3>Ссылка/Код</h3>
          <div class="field"><label>Реф-код</label><input id="rCode" readonly></div>
          <div class="field"><label>Реф‑ссылка</label><div class="row"><input id="rLink" class="grow" readonly><button class="btn" id="rCopy">Копировать</button></div></div>
        </div>
      </div>
    </section>


    <!-- ABOUT -->
    <section class="panel" data-page="about" style="display:none">
      <div class="grid cols-2">
        <div class="card">
          <h3>Доступ</h3>
          <div class="hint">
            В админ‑панель допускаются только пользователи из таблицы <code>public.admins</code>.
            Проверка идёт через RPC <code>lc_is_admin()</code>.
          </div>
          <p class="muted">Если не видите данные — добавьте свой user_id:</p>
          <pre><code>insert into public.admins(user_id)
select id from auth.users where email = 'ВАШ_EMAIL'
on conflict do nothing;</code></pre>
        </div>
        <div class="card">
          <h3>Баланс/выводы</h3>
          <p>Заявки на вывод обрабатываются через RPC <code>admin_update_withdrawal</code> (транзакционно; при отклонении средства возвращаются).</p>
          <p>Баланс меняется через политику RLS для админов или RPC <code>admin_adjust_balance</code> (если добавите).</p>
        </div>
      </div>
    </section>
  </div>

  <!-- DRAWER: USER DETAILS -->
  <div class="drawer" id="drawer">
    <div class="sheet">
      <div class="row" style="justify-content:space-between">
        <h3 id="dTitle" style="margin:6px 0">Профиль пользователя</h3>
        <button class="btn ghost" id="dClose">Закрыть</button>
      </div>

      <div class="grid cols-2">
        <div class="field"><label>User ID</label><input id="dUserId" readonly></div>
        <div class="field"><label>Создан</label><input id="dCreated" readonly></div>
        <div class="field"><label>Email</label><input id="dEmail"></div>
        <div class="field"><label>Телефон</label><input id="dPhone"></div>
        <div class="field"><label>Баланс (USDT)</label><input id="dBalance" type="number" step="0.01"></div>
        <div class="field"><label>Реф-код</label><div class="row"><input id="dRefCode"><button class="btn ghost" id="dGenRef">Сгенерировать</button></div></div>
        <div class="field"><label>Реф‑ссылка</label><div class="row"><input id="dRefLink" readonly><button class="btn" id="dCopyRef">Копировать</button></div></div>

        <div class="field"><label>Изменение (±USDT)</label><input id="dDelta" type="number" step="0.01" placeholder="например, 15 или -7.5"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn ok" id="dSaveProfile">Сохранить профиль</button>
        <button class="btn warn" id="dApplyDelta">Применить изменение баланса</button>
      </div>

      <h4 style="margin:16px 0 8px">Последние заявки пользователя</h4>
      <div class="table-wrap">
        <table id="dWTable">
          <thead><tr><th>Дата</th><th>Сумма</th><th>Статус</th><th>TX</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    
      <h4 style="margin:16px 0 8px">Реферальные начисления</h4>
      <div class="table-wrap">
        <table id="dRTable">
          <thead><tr><th>Дата</th><th>Уровень</th><th>Сумма</th><th>Источник</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(function(){
  // ---- Bootstrap Supabase client
  const haveSb = !!(window.sb);
  const SB = window.sb || (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY
    ? window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY) : null);
  if(!SB){
    alert('Не найден Supabase клиент. Либо задайте window.sb, либо SUPABASE_URL/ANON_KEY.');
    return;
  }
  window.sb = SB; // unify

  // ---- Helpers
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmtAmount = c => ((+c||0)/100).toFixed(2) + ' USDT';
  const short = s => (s ? String(s).slice(0,6)+'…'+String(s).slice(-4) : '');
  const pill = s => '<span class="pill '+s+'">'+(s==='paid'?'оплачено':s==='rejected'?'отклонено':'ожидание')+'</span>';

  let sessionUser = null;
  let isAdmin = false;

  // ---- Auth Bar
  async function refreshAuth(){
    const { data: { session } } = await sb.auth.getSession();
    sessionUser = session?.user || null;
    $('#authInfo').textContent = sessionUser ? (sessionUser.email || sessionUser.id) : 'не авторизованы';
    $('#btnLogin').style.display = sessionUser ? 'none':'inline-block';
    $('#btnLogout').style.display = sessionUser ? 'inline-block':'none';
  }
  $('#btnLogin').addEventListener('click', async () => {
    try{
      await sb.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: location.href } });
    }catch(e){ alert(e.message || e); }
  });
  $('#btnLogout').addEventListener('click', async () => {
    try{ await sb.auth.signOut(); location.reload(); }catch(e){ alert(e.message || e); }
  });
  sb.auth.onAuthStateChange((_e,s)=>{ refreshAuth(); if(s?.user){ initAfterAuth(); } });

  // ---- Tabs
  $$('.tab').forEach(t => t.addEventListener('click', () => {
    $$('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    const name = t.dataset.tab;
    $$('section.panel').forEach(s => s.style.display = (s.dataset.page===name ? '' : 'none'));
    if(name==='withdrawals') loadWithdrawals(true);
    if(name==='users') loadUsers(true);
  }));

  // ---- Ensure admin
  async function ensureAdmin(){
    const { data, error } = await sb.rpc('lc_is_admin');
    if(error){ console.warn(error); return false; }
    return data === true;
  }

  // ---- Withdrawals
  let wPage = 0, wLimit = 30;
  async function loadWithdrawals(reset=false){
    if(reset) wPage = 0;
    const st = $('#wStatus').value;
    const q = ($('#wSearch').value||'').trim().toLowerCase();

    let sel = sb.from('withdrawals')
      .select('id,user_id,amount_cents,status,txid,network,address,paid_at,created_at')
      .order('created_at',{ascending:false})
      .range(wPage*wLimit, wPage*wLimit + wLimit - 1);

    if(st) sel = sel.eq('status', st);
    if(q) sel = sel.or(`id.ilike.%${q}%,address.ilike.%${q}%,txid.ilike.%${q}%`);

    const { data, error } = await sel;
    if(error){ $('#wDiag').textContent = 'Ошибка: '+(error.message||error); return; }
    const rows = Array.isArray(data)?data:[];

    // fetch profiles
    const uids = [...new Set(rows.map(r=>r.user_id).filter(Boolean))];
    let byUser = {};
    if(uids.length){
      const { data: prof } = await sb.from('profiles').select('id,email,phone').in('id', uids);
      if(Array.isArray(prof)) byUser = Object.fromEntries(prof.map(p=>[p.id,p]));
    }

    const tb = $('#wTable tbody'); tb.innerHTML='';
    rows.forEach(r => {
      const p = byUser[r.user_id] || {};
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td title="${r.user_id}">${short(r.user_id)}</td>
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td>${p.email||'—'}</td>
        <td>${p.phone||'—'}</td>
        <td class="right">${fmtAmount(r.amount_cents)}</td>
        <td>${r.address||'—'} <span class="muted">${r.network||''}</span></td>
        <td>${pill(r.status)}</td>
        <td><input data-tx="${r.id}" placeholder="TX / примечание" value="${r.txid||''}" style="height:34px;min-width:180px"></td>
        <td class="nowrap">
          <button class="btn ok" data-paid="${r.id}">Оплачено</button>
          <button class="btn bad" data-rej="${r.id}">Отклонить</button>
        </td>`;
      tb.appendChild(tr);
    });

    $('#wDiag').textContent = rows.length ? `Показано ${rows.length} записей` : 'Нет записей';
  }
  $('#wReload').addEventListener('click', ()=>loadWithdrawals(true));
  $('#wPrev').addEventListener('click', ()=>{ if(wPage>0){ wPage--; loadWithdrawals(false); } });
  $('#wNext').addEventListener('click', ()=>{ wPage++; loadWithdrawals(false); });
  $('#wTable').addEventListener('click', async (e) => {
    const paidId = e.target.dataset?.paid;
    const rejId  = e.target.dataset?.rej;
    if(!paidId && !rejId) return;
    const id = paidId || rejId;
    const status = paidId ? 'paid' : 'rejected';
    const tx = document.querySelector(`input[data-tx="${id}"]`)?.value || null;
    const note = (status==='rejected' && !tx) ? (prompt('Причина отклонения?') || null) : tx;
    e.target.disabled = true;
    const { error } = await sb.rpc('admin_update_withdrawal', {
      p_withdrawal_id: id, p_status: status, p_txid: note
    });
    e.target.disabled = false;
    if(error){ return alert('Ошибка: '+(error.message||error)); }
    alert(status==='paid' ? 'Оплата подтверждена' : 'Заявка отклонена — средства возвращены');
    loadWithdrawals(false);
  });


  // ---- Refs
  async function fetchRefCounts(targetUserId){
    try{
      const { data, error } = await sb.rpc('ref_counts', { p_user: targetUserId });
      if(error) { console.warn('[refs] ref_counts', error); return {gen1:0,gen2:0,gen3:0}; }
      const row = Array.isArray(data) ? (data[0]||{}) : (data||{});
      const vals = Object.values(row||{}).map(n=>Number(n)||0);
      return { gen1: vals[0]||0, gen2: vals[1]||0, gen3: vals[2]||0 };
    }catch(e){ console.warn('[refs] ref_counts', e); return {gen1:0,gen2:0,gen3:0}; }
  }
  async function fetchRefSums(targetUserId){
    let sums = {1:0,2:0,3:0};
    try{
      const resp = await sb.from('referral_payouts').select('level,reward_usdt').eq('referrer_user_id', targetUserId);
      if(!resp.error && Array.isArray(resp.data)){
        resp.data.forEach(r => { const L=Number(r.level||0); const v=Number(r.reward_usdt||0); if(L>=1 && L<=3) sums[L]+=v; });
        return sums;
      }
    }catch(_){}
    try{
      const resp = await sb.from('referral_rewards').select('level,reward_usdt').eq('referrer_user_id', targetUserId);
      if(!resp.error && Array.isArray(resp.data)){
        resp.data.forEach(r => { const L=Number(r.level||0); const v=Number(r.reward_usdt||0); if(L>=1 && L<=3) sums[L]+=v; });
      }
    }catch(_){}
    return sums;
  }
  async function fetchRefLast(targetUserId, limit=20){
    try{
      const v = await sb.from('v_referral_payouts').select('created_at,level,reward_usdt,source').eq('referrer_user_id', targetUserId).order('created_at',{ascending:false}).limit(limit);
      if(!v.error && Array.isArray(v.data)) return v.data;
    }catch(_){}
    try{
      const p = await sb.from('referral_payouts').select('created_at,level,reward_usdt,source').eq('referrer_user_id', targetUserId).order('created_at',{ascending:false}).limit(limit);
      if(!p.error && Array.isArray(p.data)) return p.data;
    }catch(_){}
    try{
      const r = await sb.from('referral_rewards').select('created_at,level,reward_usdt,source').eq('referrer_user_id', targetUserId).order('created_at',{ascending:false}).limit(limit);
      if(!r.error && Array.isArray(r.data)) return r.data;
    }catch(_){}
    return [];
  }
  function setRefOverview({gen1,gen2,gen3}, sums){
    const fmt = v => (Number(v||0)).toLocaleString('ru-RU', {minimumFractionDigits:0, maximumFractionDigits:2});
    $('#rGen1').textContent = String(gen1);
    $('#rGen2').textContent = String(gen2);
    $('#rGen3').textContent = String(gen3);
    $('#rSum1').textContent = fmt(sums[1])+' USDT';
    $('#rSum2').textContent = fmt(sums[2])+' USDT';
    $('#rSum3').textContent = fmt(sums[3])+' USDT';
  }
  async function loadRefsFor(userId){
    const [counts, sums, last] = await Promise.all([fetchRefCounts(userId), fetchRefSums(userId), fetchRefLast(userId, 20)]);
    setRefOverview(counts, sums);
    const tb = $('#rLast tbody'); tb.innerHTML='';
    last.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(r.created_at).toLocaleString()}</td>
                      <td>${r.level||'-'}</td>
                      <td>${Number(r.reward_usdt||0).toFixed(2)} USDT</td>
                      <td>${r.source||''}</td>`;
      tb.appendChild(tr);
    });
  }
  $('#rLoad').addEventListener('click', async ()=>{
    const id = ($('#rUser').value||'').trim();
    if(!id) return alert('Укажите User ID (или откройте пользователя во вкладке «Пользователи»).');
    await loadRefsFor(id);
    try{
      const { data: prof } = await sb.from('profiles').select('ref_code').eq('user_id', id).maybeSingle();
      const code = prof?.ref_code || '';
      $('#rCode').value = code;
      const base = location.origin || '';
      $('#rLink').value = code ? (base + '/?ref=' + encodeURIComponent(code)) : '';
    }catch(_){}
  });
  $('#rCopy').addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText($('#rLink').value||''); $('#rCopy').textContent='Скопировано'; setTimeout(()=>$('#rCopy').textContent='Копировать',1200);}catch(_){}
  });

  // ---- Users

  let uPage = 0, uLimit = 40;
  async function loadUsers(reset=false){
    if(reset) uPage=0;
    const q = ($('#uSearch').value||'').trim().toLowerCase();

    let sel = sb.from('profiles').select('user_id,created_at,email,phone,ref_code').order('created_at',{ascending:false}).range(uPage*uLimit, uPage*uLimit+uLimit-1);
    if(q){
      // simple client side filter post-load (to keep compatibility with any RLS)
      const { data, error } = await sel;
      if(error){ $('#uDiag').textContent='Ошибка: '+(error.message||error); return; }
      let rows = Array.isArray(data)?data:[];
      rows = rows.filter(p =>
        String(p.id).toLowerCase().includes(q) ||
        String(p.email||'').toLowerCase().includes(q) ||
        String(p.phone||'').toLowerCase().includes(q)
      );
      await renderUsers(rows);
    }else{
      const { data, error } = await sel;
      if(error){ $('#uDiag').textContent='Ошибка: '+(error.message||error); return; }
      await renderUsers(Array.isArray(data)?data:[]);
    }
  }
  async function renderUsers(rows){
    // fetch wallets
    const uids = rows.map(r=>r.user_id);
    let byWallet = {};
    if(uids.length){
      const { data: ws } = await sb.from('wallets').select('user_id,balance_cents').in('user_id', uids);
      if(Array.isArray(ws)) byWallet = Object.fromEntries(ws.map(w=>[w.user_id, w]));
    }
    const tb = $('#uTable tbody'); tb.innerHTML='';
    rows.forEach(r => {
      const w = byWallet[r.id] || { balance_cents: 0 };
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td title="${r.user_id}">${short(r.user_id)}</td>
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td>${r.email||'—'}</td>
        <td>${r.phone||'—'}</td>
        <td class="right">${fmtAmount(w.balance_cents)}</td>
        <td class="nowrap"><button class="btn" data-edit="${r.user_id}">Открыть</button></td>`;
      tb.appendChild(tr);
    });
    $('#uDiag').textContent = rows.length ? `Показано ${rows.length} пользователей` : 'Нет пользователей';
  }
  $('#uReload').addEventListener('click', ()=>loadUsers(true));
  $('#uTable').addEventListener('click', (e) => {
    const id = e.target.dataset?.edit;
    if(id) openUser(id);
  });

  // ---- Drawer User
  async function openUser(userId){
    $('#drawer').classList.add('open');
    $('#dUserId').value = userId;
    $('#dTitle').textContent = 'Профиль пользователя';
    $('#dEmail').value = ''; $('#dPhone').value=''; $('#dBalance').value=''; $('#dDelta').value='';
    $('#dWTable tbody').innerHTML = '<tr><td colspan="4" class="muted">Загрузка…</td></tr>';

    const [{ data: prof }, { data: wal }, { data: wd }] = await Promise.all([
      sb.from('profiles').select('user_id,created_at,email,phone,ref_code').eq('user_id', userId).maybeSingle(),
      sb.from('wallets').select('user_id,balance_cents').eq('user_id', userId).maybeSingle(),
      sb.from('withdrawals').select('created_at,amount_cents,status,txid').eq('user_id', userId).order('created_at',{ascending:false}).limit(20)
    ]);
    if(prof){
      $('#dCreated').value = new Date(prof.created_at).toLocaleString();
      $('#dEmail').value = prof.email || '';
      $('#dPhone').value = prof.phone || '';
      $('#dRefCode').value = prof.ref_code || '';
      $('#dRefLink').value = (prof.ref_code? (location.origin + '/?ref='+encodeURIComponent(prof.ref_code)) : '');
    }else{
      $('#dCreated').value = '—';
    }
    const bal = wal?.balance_cents ?? 0;
    $('#dBalance').value = (bal/100).toFixed(2);

    const tb = $('#dWTable tbody'); tb.innerHTML = ''; // withdrawals
    // referral payouts
    const rtb = $('#dRTable tbody'); if (rtb) {
      rtb.innerHTML = '<tr><td colspan="4" class="muted">Загрузка…</td></tr>';
      const last = await fetchRefLast(userId, 20);
      rtb.innerHTML = '';
      last.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(r.created_at).toLocaleString()}</td>
                        <td>${r.level||'-'}</td>
                        <td>${Number(r.reward_usdt||0).toFixed(2)} USDT</td>
                        <td>${r.source||''}</td>`;
        rtb.appendChild(tr);
      });
    }
    (Array.isArray(wd)?wd:[]).forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(r.created_at).toLocaleString()}</td>
                      <td>${fmtAmount(r.amount_cents)}</td>
                      <td>${r.status}</td>
                      <td>${r.txid||''}</td>`;
      tb.appendChild(tr);
    });

    $('#dSaveProfile').onclick = async () => {
      const email = $('#dEmail').value.trim() || null;
      const phone = $('#dPhone').value.trim() || null;
      const { error } = await sb.from('profiles').update({ email, phone }).eq('user_id', userId);
      if(error){ alert('Ошибка сохранения профиля: '+(error.message||error)); }
      else { alert('Профиль сохранён'); loadUsers(false); }
    };

    
  $('#dGenRef').onclick = async () => {
    const rnd = () => Array.from(crypto.getRandomValues(new Uint8Array(6))).map(n => 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'[n%36]).join('');
    let code = rnd(); let tries = 0;
    while(tries++ < 8){
      const { data } = await sb.from('profiles').select('user_id').eq('ref_code', code).limit(1);
      if(!data || !data.length) break; code = rnd();
    }
    $('#dRefCode').value = code;
    $('#dRefLink').value = location.origin + '/?ref='+encodeURIComponent(code);
  };
  $('#dCopyRef').onclick = async () => {
    try{ await navigator.clipboard.writeText($('#dRefLink').value||''); $('#dCopyRef').textContent='Скопировано'; setTimeout(()=>$('#dCopyRef').textContent='Копировать',1200);}catch(_){}
  };

  $('#dApplyDelta').onclick = async () => {
      const delta = Math.round((parseFloat($('#dDelta').value||'0')||0)*100);
      if(!delta) return alert('Укажите изменение баланса (±USDT)');
      const reason = prompt('Причина изменения баланса?') || null;

      // Try RPC first (если добавлен admin_adjust_balance), иначе прямое обновление (требует RLS-политики для админа)
      let ok = false, err = null;
      try{
        const { error } = await sb.rpc('admin_adjust_balance', { p_user_id: userId, p_delta_cents: delta, p_reason: reason });
        if(!error){ ok = True; }
        else err = error;
      }catch(e){ err = e; }

      if(!ok){
        // fallback: direct update
        const cur = Math.round(parseFloat($('#dBalance').value||'0')*100);
        const next = cur + delta;
        const { error } = await sb.from('wallets').update({ balance_cents: next }).eq('user_id', userId);
        if(error){ return alert('Ошибка изменения баланса: '+(error.message||error)); }
      }
      alert('Баланс обновлён');
      openUser(userId); // reload
      loadUsers(false);
    };
  }
  $('#dClose').addEventListener('click', ()=>$('#drawer').classList.remove('open'));

  // ---- Boot
  async function initAfterAuth(){
    isAdmin = await ensureAdmin();
    if(!isAdmin){ alert('Нет прав администратора. Добавьте ваш user_id в public.admins'); return; }
    // default tab
    loadWithdrawals(true);
  }

  (async function start(){
    await refreshAuth();
    const { data: { user } } = await sb.auth.getUser();
    if(user) await initAfterAuth();
  })();
})();
</script>

</body>
</html>
