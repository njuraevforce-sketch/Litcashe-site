<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LC • Admin (Light)</title>
  <link rel="icon" href="data:,">
  <!-- Supabase client from CDN -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
    (function(){
      try {
        if (!window.supabase) throw new Error('supabase.js not loaded');
        window.sb = window.supabase.createClient(
'https://einpfuegfsilnoiareco.supabase.co',
'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpbnBmdWVnZnNpbG5vaWFyZWNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjM3NzAsImV4cCI6MjA2OTk5OTc3MH0.6wF-8yaV38LrXH6Ptm3KIO34wRklJKbNCVoqIGNKh_w',
          { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
        );
        console.log('[Admin] Supabase init OK');
      } catch (e) { console.error('[Admin] Supabase init error', e); }
    })();
  </script>
  <style>
    :root{
      --bg:#f7f8fa; --panel:#ffffff; --text:#17223b; --muted:#6b7280; --accent:#2563eb;
      --ok:#10b981; --warn:#eab308; --bad:#ef4444; --line:#e5e7eb; --chip:#f3f4f6;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1280px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{font-weight:800;font-size:18px;letter-spacing:.2px}
    .authbar{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted)}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;transition:.15s}
    .btn:hover{box-shadow:0 1px 0 rgba(0,0,0,.05)}
    .btn.ok{background:#ecfdf5;border-color:#d1fae5}
    .btn.warn{background:#fffbeb;border-color:#fef3c7}
    .btn.bad{background:#fef2f2;border-color:#fee2e2}
    .btn.ghost{background:#fff}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .tab.active{background:#e8f0ff;border-color:#c7d2fe;color:#1e40af}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    input,select,textarea{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{background:#f9fafb;border-bottom:1px solid var(--line);padding:10px;text-align:left;white-space:nowrap}
    td{border-top:1px solid var(--line);padding:10px;vertical-align:top}
    .right{text-align:right}
    .chip{display:inline-block;background:var(--chip);border:1px solid var(--line);padding:3px 8px;border-radius:999px;font-size:12px}
    .pill{padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
    .pill.paid{background:#ecfdf5;border-color:#d1fae5;color:#065f46}
    .pill.pending{background:#eff6ff;border-color:#dbeafe;color:#1e40af}
    .pill.rejected{background:#fef2f2;border-color:#fee2e2;color:#991b1b}
    .drawer{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-end;justify-content:flex-end}
    .drawer.open{display:flex}
    .drawer .sheet{width:560px;max-width:92vw;height:100%;overflow:auto;background:#fff;border-left:1px solid var(--line);padding:16px}
    .small{font-size:12px}
    .nowrap{white-space:nowrap}
    h3{margin:6px 0 8px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">LC • Admin</div>
    <div class="authbar">
      <span class="muted small">Аккаунт:</span>
      <span id="authInfo" class="nowrap">—</span>
      <button class="btn" id="btnLogin">Войти</button>
      <button class="btn" id="btnLogout" style="display:none">Выйти</button>
    </div>
  </div>

  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="withdrawals">Заявки</button>
    <button class="tab" data-tab="users">Пользователи</button>
    <button class="tab" data-tab="refs">Рефералы</button>
    <button class="tab" data-tab="rewards">Начисления</button>
    <button class="tab" data-tab="about">Настройки/Справка</button>
  </div>

  <!-- WITHDRAWALS -->
  <section class="panel" data-page="withdrawals">
    <div class="row">
      <select id="wStatus">
        <option value="">Все статусы</option>
        <option value="pending">Ожидание</option>
        <option value="paid">Оплачено</option>
        <option value="rejected">Отклонено</option>
      </select>
      <input id="wSearch" class="grow" placeholder="Поиск: id, адрес, TX, email, телефон">
      <input id="wFrom" type="date">
      <input id="wTo" type="date">
      <button class="btn" id="wReload">Обновить</button>
      <button class="btn ghost" id="wExport">Экспорт CSV</button>
    </div>
    <div class="table-wrap" style="margin-top:8px">
      <table id="wTable">
        <thead><tr>
          <th>ID</th><th>Создано</th><th>Email</th><th>Телефон</th>
          <th class="right">Сумма</th><th class="right">Комиссия</th><th class="right">Итого</th>
          <th>Сеть</th><th>Адрес</th><th>Статус</th><th>TX/Примечание</th><th></th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="muted small" id="wDiag">—</span>
      <span class="grow"></span>
      <button class="btn ghost" id="wPrev">Назад</button>
      <button class="btn ghost" id="wNext">Вперёд</button>
    </div>
  </section>

  <!-- USERS -->
  <section class="panel" data-page="users" style="display:none">
    <div class="row">
      <input id="uSearch" class="grow" placeholder="Поиск: email, телефон, user_id, ref_code">
      <button class="btn" id="uReload">Обновить</button>
      <button class="btn ghost" id="uExport">Экспорт CSV</button>
      <span class="muted small" id="uDiag">—</span>
    </div>
    <div class="table-wrap" style="margin-top:8px">
      <table id="uTable">
        <thead><tr>
          <th>ID</th><th>Создано</th><th>Email</th><th>Телефон</th>
          <th class="right">Баланс</th><th>Реф-код</th><th>Реф-ссылка</th><th></th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- REFS -->
  <section class="panel" data-page="refs" style="display:none">
    <div class="row">
      <input id="rInviter" class="grow" placeholder="User ID пригласившего (показать его L1)">
      <button class="btn" id="rLoadL1">Показать L1</button>
      <button class="btn ghost" id="rExportL1">Экспорт L1</button>
    </div>
    <div class="table-wrap" style="margin-top:8px">
      <table id="rL1Table">
        <thead><tr><th>User ID</th><th>Email</th><th>Телефон</th><th class="right">Баланс</th><th>Реф-код</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="row" style="margin-top:12px">
      <input id="treeUser" class="grow" placeholder="User ID (корень дерева 1–3)">
      <button class="btn" id="treeLoad">Построить дерево 1–3</button>
      <button class="btn ghost" id="treeExport">Экспорт дерева</button>
    </div>
    <div class="table-wrap" style="margin-top:8px">
      <table id="treeTable">
        <thead><tr><th>Уровень</th><th>User ID</th><th>Email</th><th>Телефон</th><th class="right">Баланс</th><th>Реф-код</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- REWARDS -->
  <section class="panel" data-page="rewards" style="display:none">
    <div class="row">
      <input id="rwSearch" class="grow" placeholder="Поиск: source_user, target_user, уровень">
      <button class="btn" id="rwReload">Обновить</button>
      <button class="btn ghost" id="rwExport">Экспорт CSV</button>
      <span class="muted small" id="rwDiag">—</span>
    </div>
    <div class="table-wrap" style="margin-top:8px">
      <table id="rwTable">
        <thead><tr>
          <th>Дата</th><th>Уровень</th><th>Получатель</th><th>Источник</th><th class="right">Сумма</th><th>Комментарий</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ABOUT -->
  <section class="panel" data-page="about" style="display:none">
    <h3>Справка</h3>
    <p class="small muted">Панель работает с таблицами <code>profiles(user_id,email,phone,ref_code)</code>, <code>wallets(user_id,balance_cents)</code>, <code>withdrawals</code>, <code>referral_rewards</code> и RPC: <code>lc_is_admin</code>, <code>admin_update_withdrawal</code>, <code>admin_adjust_balance</code>, <code>get_referrals_by_generation</code>.</p>
  </section>
</div>

<!-- Drawer -->
<div class="drawer" id="drawer">
  <div class="sheet">
    <div class="row" style="justify-content:space-between">
      <h3 id="dTitle" style="margin:6px 0">Профиль пользователя</h3>
      <button class="btn ghost" id="dClose">Закрыть</button>
    </div>
    <div class="row">
      <div class="grow">
        <div class="small muted">User ID</div><input id="dUserId" class="grow" readonly>
      </div>
      <div class="grow">
        <div class="small muted">Создан</div><input id="dCreated" class="grow" readonly>
      </div>
    </div>
    <div class="row">
      <div class="grow"><div class="small muted">Email</div><input id="dEmail" class="grow"></div>
      <div class="grow"><div class="small muted">Телефон</div><input id="dPhone" class="grow"></div>
    </div>
    <div class="row">
      <div class="grow"><div class="small muted">Баланс (USDT)</div><input id="dBalance" type="number" step="0.01" class="grow"></div>
      <div class="grow"><div class="small muted">Реф-код</div><input id="dRefCode" class="grow"></div>
    </div>
    <div class="row">
      <div class="grow"><div class="small muted">Реф-ссылка</div><input id="dRefLink" class="grow" readonly></div>
      <button class="btn" id="dCopyRef">Копировать</button>
    </div>
    <div class="row">
      <div class="grow"><div class="small muted">Изменение (±USDT)</div><input id="dDelta" type="number" step="0.01" class="grow" placeholder="например, 15 или -7.5"></div>
      <button class="btn warn" id="dApplyDelta">Применить</button>
      <button class="btn ok" id="dSaveProfile">Сохранить</button>
    </div>
    <h3>Заявки пользователя</h3>
    <div class="table-wrap">
      <table id="dWTable"><thead><tr><th>Дата</th><th>Сумма</th><th>Статус</th><th>TX</th></tr></thead><tbody></tbody></table>
    </div>
    <h3>Реферальные начисления</h3>
    <div class="table-wrap">
      <table id="dRTable"><thead><tr><th>Дата</th><th>Уровень</th><th>Сумма</th><th>Источник</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script>
(function(){

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const sb = window.sb;
  if (!sb) { alert('Supabase не инициализирован'); }
  const fmtCents = c => ((+c||0)/100).toLocaleString('ru-RU', {minimumFractionDigits:0, maximumFractionDigits:2}) + ' USDT';
  const pill = s => '<span class="pill '+s+'">'+(s==='paid'?'оплачено':s==='rejected'?'отклонено':'ожидание')+'</span>';
  const short = s => (s ? String(s).slice(0,6)+'…'+String(s).slice(-4) : '');
  const toCents = v => Math.round((Number(v)||0) * 100);
  const qlike = v => v? '%' + String(v).toLowerCase().trim() + '%' : null;

  let sessionUser = null, isAdmin = false;

  // Tabs
  $$('#tabs .tab').forEach(btn => {
    btn.addEventListener('click', () => {
      $$('#tabs .tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      $$('[data-page]').forEach(p => p.style.display = (p.getAttribute('data-page') === tab) ? 'block' : 'none');
      if (tab === 'withdrawals') loadWithdrawals();
      if (tab === 'users') loadUsers();
      if (tab === 'rewards') loadRewards();
    });
  });

  // Auth
  async function refreshAuth(){
    const { data: { session } } = await sb.auth.getSession();
    sessionUser = session?.user || null;
    $('#authInfo').textContent = sessionUser ? (sessionUser.email || sessionUser.id) : 'не авторизованы';
    $('#btnLogin').style.display = sessionUser ? 'none':'inline-block';
    $('#btnLogout').style.display = sessionUser ? 'inline-block':'none';
  }
  $('#btnLogin').addEventListener('click', async () => {
    try{
      const email = prompt('Email для входа:');
      if(!email) return;
      const pwd = prompt('Пароль (оставьте пустым для magic-link):') || '';
      if(pwd){
        const { error } = await sb.auth.signInWithPassword({ email, password: pwd });
        if(error){ alert('Ошибка: '+(error.message||error)); return; }
        location.reload();
      } else {
        const { error } = await sb.auth.signInWithOtp({ email, options: { emailRedirectTo: location.href } });
        if(error){ alert('Ошибка отправки ссылки: '+(error.message||error)); return; }
        alert('Ссылка для входа отправлена на email.');
      }
    }catch(e){ alert(e.message||e); }
  });
  $('#btnLogout').addEventListener('click', async ()=>{ await sb.auth.signOut(); location.reload(); });

  async function checkAdmin(){
    isAdmin = false;
    try {
      const r = await sb.rpc('lc_is_admin');
      if (!r.error) {
        const row = Array.isArray(r.data) ? r.data[0] : r.data;
        if (row === true || row?.is_admin === true) isAdmin = true;
      }
    } catch(_) {}

    if (!isAdmin) {
      try{
        const { data: { user } } = await sb.auth.getUser();
        if (user) {
          const q = await sb.from('admins').select('user_id').eq('user_id', user.id).maybeSingle();
          if (!q.error && q.data?.user_id) isAdmin = true;
        }
      }catch(_){}
    }

    if (!isAdmin) {
      alert('Доступ запрещён: вы не администратор.');
      $$('#tabs .tab').forEach(b=>b.disabled=true);
    }
  }

  // Withdrawals
  let wPage=0, wLimit=25, wLastCount=0, wRowsCache=[];
  async function loadWithdrawals(){
    if (!isAdmin) return;
    const tbody = $('#wTable tbody'); tbody.innerHTML = '<tr><td colspan="12" class="muted small">Загрузка…</td></tr>';
    const status = $('#wStatus').value || null;
    const s = $('#wSearch').value.trim();
    const from = $('#wFrom').value ? new Date($('#wFrom').value) : null;
    const to = $('#wTo').value ? new Date($('#wTo').value) : null;

    let q = sb.from('withdrawals')
      .select('id, created_at, user_id, amount_cents, fee_cents, status, txid, note, network, address', { count:'exact' })
      .order('created_at', { ascending:false })
      .range(wPage*wLimit, wPage*wLimit + wLimit - 1);
    if (status) q = q.eq('status', status);
    if (from) q = q.gte('created_at', from.toISOString());
    if (to) q = q.lte('created_at', to.toISOString());
    if (s) {
      const like = qlike(s);
      q = q.or('id.ilike.'+like+',address.ilike.'+like+',txid.ilike.'+like+',note.ilike.'+like);
    }
    const { data, error, count } = await q;
    if (error) { tbody.innerHTML = '<tr><td colspan="12" class="small" style="color:#b91c1c">'+(error.message||error)+'</td></tr>'; return; }
    wLastCount = count || 0; wRowsCache = data||[]; $('#wDiag').textContent = 'Страница '+(wPage+1)+' · '+wLastCount+' записей';

    const emailByUser={}, phoneByUser={};
    try {
      const ids = (data||[]).map(r=>r.user_id).filter(Boolean);
      if (ids.length) {
        const { data: profs } = await sb.from('profiles').select('user_id, email, phone').in('user_id', ids);
        (profs||[]).forEach(p=>{ emailByUser[p.user_id]=p.email; phoneByUser[p.user_id]=p.phone; });
      }
    }catch(_){}

    tbody.innerHTML='';
    if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="12" class="muted small">Пусто</td></tr>'; return; }
    for (const r of data) {
      const amount = r.amount_cents||0, fee=r.fee_cents||0, total=amount+fee;
      const tr = document.createElement('tr');
      tr.innerHTML = '<td class="nowrap">'+r.id+'</td>'
        + '<td class="nowrap">'+new Date(r.created_at).toLocaleString()+'</td>'
        + '<td>'+(emailByUser[r.user_id]||'—')+'</td>'
        + '<td>'+(phoneByUser[r.user_id]||'—')+'</td>'
        + '<td class="right">'+fmtCents(amount)+'</td>'
        + '<td class="right">'+fmtCents(fee)+'</td>'
        + '<td class="right">'+fmtCents(total)+'</td>'
        + '<td>'+(r.network||'—')+'</td>'
        + '<td class="nowrap">'+(r.address?('<code>'+r.address+'</code>'):'—')+'</td>'
        + '<td>'+ (function(s){s=String(s||'pending').toLowerCase(); return '<span class="pill '+s+'">'+(s==='paid'?'оплачено':s==='rejected'?'отклонено':'ожидание')+'</span>';})(r.status) +'</td>'
        + '<td class="nowrap">'+(r.txid?('<code>'+short(r.txid)+'</code>'):'—')+(r.note?('<div class="small muted">'+r.note+'</div>'):'')+'</td>'
        + '<td class="nowrap">'
          + '<button class="btn ok small" data-act="pay" data-id="'+r.id+'">Оплатить</button> '
          + '<button class="btn bad small" data-act="reject" data-id="'+r.id+'">Отклонить</button> '
          + '<button class="btn ghost small" data-act="view" data-user="'+r.user_id+'">Профиль</button>'
        + '</td>';
      tbody.appendChild(tr);
    }
  }
  $('#wReload').addEventListener('click', ()=>{ wPage=0; loadWithdrawals(); });
  $('#wPrev').addEventListener('click', ()=>{ if (wPage>0){ wPage--; loadWithdrawals(); } });
  $('#wNext').addEventListener('click', ()=>{ if ((wPage+1)*wLimit < wLastCount){ wPage++; loadWithdrawals(); } });
  $('#wTable').addEventListener('click', async (e)=>{ const btn=e.target.closest('button[data-act]'); if(!btn) return;
    const id=btn.dataset.id, act=btn.dataset.act;
    if(act==='view'){ openUserDrawer(btn.dataset.user); return; }
    if(act==='pay'){ const tx=prompt('TX/комментарий для "Оплачено":'); if(!tx) return;
      try{ const r=await sb.rpc('admin_update_withdrawal', { p_id:id, p_status:'paid', p_txid:tx, p_note:tx }); if(r.error) throw r.error; loadWithdrawals(); }
      catch(e){ alert(e.message||e); } }
    if(act==='reject'){ const note=prompt('Причина отмены:')||'rejected by admin';
      try{ const r=await sb.rpc('admin_update_withdrawal', { p_id:id, p_status:'rejected', p_txid:null, p_note:note }); if(r.error) throw r.error; loadWithdrawals(); }
      catch(e){ alert(e.message||e); } }
  });
  $('#wExport').addEventListener('click', ()=>{ exportCSV('withdrawals.csv', (wRowsCache||[])); });

  try{ sb.channel('adm-wd').on('postgres_changes', { event:'*', schema:'public', table:'withdrawals' }, ()=>{ if($('.tab.active')?.dataset.tab==='withdrawals') loadWithdrawals(); }).subscribe(); }catch(_){}

  // Users
  let uRowsCache=[];
  async function loadUsers(){
    if (!isAdmin) return;
    const tbody = $('#uTable tbody'); tbody.innerHTML = '<tr><td colspan="8" class="muted small">Загрузка…</td></tr>';
    const s = $('#uSearch').value.trim();
    let rows=null;
    try { const r = await sb.rpc('admin_list_users', { p_search: s||null }); if(!r.error) rows = Array.isArray(r.data)? r.data : (r.data? [r.data] : []); } catch(_){}
    if (!rows) {
      let q = sb.from('profiles').select('user_id, created_at, email, phone, ref_code').order('created_at', {ascending:false}).limit(300);
      if (s) { const like=qlike(s); q = q.or('user_id.ilike.'+like+',email.ilike.'+like+',phone.ilike.'+like+',ref_code.ilike.'+like); }
      const r = await q; if (r.error) { tbody.innerHTML='<tr><td colspan="8" class="small" style="color:#b91c1c">'+(r.error.message||r.error)+'</td></tr>'; return; }
      const ids = (r.data||[]).map(p=>p.user_id);
      let balances={}; if (ids.length) { const w = await sb.from('wallets').select('user_id, balance_cents').in('user_id', ids); (w.data||[]).forEach(x=>balances[x.user_id]=x.balance_cents||0); }
      rows = (r.data||[]).map(p=>({ user_id:p.user_id, created_at:p.created_at, email:p.email, phone:p.phone, ref_code:p.ref_code, balance_cents: balances[p.user_id]||0 }));
    }
    uRowsCache = rows||[]; $('#uDiag').textContent = uRowsCache.length+' пользователей';
    tbody.innerHTML=''; if(!uRowsCache.length){ tbody.innerHTML='<tr><td colspan="8" class="muted small">Пусто</td></tr>'; return; }
    for (const r of uRowsCache) {
      const link = buildRefLink(r.ref_code);
      const tr = document.createElement('tr');
      tr.innerHTML = '<td class="nowrap">'+r.user_id+'</td>'
        + '<td class="nowrap">'+new Date(r.created_at).toLocaleString()+'</td>'
        + '<td>'+(r.email||'—')+'</td>'
        + '<td>'+(r.phone||'—')+'</td>'
        + '<td class="right">'+fmtCents(r.balance_cents||0)+'</td>'
        + '<td>'+(r.ref_code||'—')+'</td>'
        + '<td class="nowrap">'+(link?('<code>'+link+'</code>'):'—')+'</td>'
        + '<td class="nowrap"><button class="btn ghost small" data-open="'+r.user_id+'">Открыть</button></td>';
      tbody.appendChild(tr);
    }
  }
  $('#uReload').addEventListener('click', loadUsers);
  $('#uTable').addEventListener('click', e=>{ const btn=e.target.closest('button[data-open]'); if(!btn) return; openUserDrawer(btn.dataset.open); });
  $('#uExport').addEventListener('click', ()=>exportCSV('users.csv', uRowsCache));

  // Rewards
  let rwRowsCache=[];
  async function loadRewards(){
    if (!isAdmin) return;
    const tbody = $('#rwTable tbody'); tbody.innerHTML = '<tr><td colspan="6" class="muted small">Загрузка…</td></tr>';
    const s = $('#rwSearch').value.trim();
    let q = sb.from('referral_rewards').select('created_at, level, target_user_id, source_user_id, amount_cents, note').order('created_at', {ascending:false}).limit(300);
    if (s) { const like=qlike(s); q = q.or('target_user_id.ilike.'+like+',source_user_id.ilike.'+like+',level.eq.'+(Number(s)||-1)); }
    const r = await q; if (r.error) { tbody.innerHTML='<tr><td colspan="6" class="small" style="color:#b91c1c">'+(r.error.message||r.error)+'</td></tr>'; return; }
    rwRowsCache = r.data||[]; $('#rwDiag').textContent = rwRowsCache.length+' записей';
    tbody.innerHTML=''; if(!rwRowsCache.length){ tbody.innerHTML='<tr><td colspan="6" class="muted small">Пусто</td></tr>'; return; }
    for (const x of rwRowsCache) {
      const tr=document.createElement('tr');
      tr.innerHTML = '<td class="nowrap">'+new Date(x.created_at).toLocaleString()+'</td>'
        + '<td>'+x.level+'</td>'
        + '<td class="nowrap">'+x.target_user_id+'</td>'
        + '<td class="nowrap">'+x.source_user_id+'</td>'
        + '<td class="right">'+fmtCents(x.amount_cents||0)+'</td>'
        + '<td>'+(x.note||'—')+'</td>';
      tbody.appendChild(tr);
    }
  }
  $('#rwReload').addEventListener('click', loadRewards);
  $('#rwExport').addEventListener('click', ()=>exportCSV('rewards.csv', rwRowsCache));

  // Referrals: L1 list by inviter
  async function loadL1(inviterId){
const tbody = $('#rL1Table tbody'); tbody.innerHTML = '<tr><td colspan="5" class="muted small">Загрузка…</td></tr>';
if (!inviterId) { tbody.innerHTML = '<tr><td colspan="5" class="muted small">Укажите User ID пригласившего</td></tr>'; return; }
let rows = [];
// 1) Пытаемся через RPC
try { 
  const r = await sb.rpc('get_referrals_by_generation', { p_level:1, p_min_cents:0, p_root_user: inviterId });
  const list = Array.isArray(r.data) ? r.data : (r.data? [r.data] : []);
  rows = list.map(x=>({ user_id:x.user_id }));
} catch (_){}
// 2) Фолбэк: через VIEW profiles_refs_admin
if (!rows.length) {
  // по inviter_id
  const v1 = await sb.from('profiles_refs_admin').select('user_id,email,phone,ref_code').eq('inviter_id', inviterId).limit(1000);
  if (!v1.error && v1.data && v1.data.length) {
    rows = v1.data;
  } else {
    // по invited_by_code (реф-код родителя)
    const root = await sb.from('profiles_refs_admin').select('ref_code').eq('user_id', inviterId).maybeSingle();
    const code = root.data?.ref_code;
    if (code) {
       const v2 = await sb.from('profiles_refs_admin').select('user_id,email,phone,ref_code').eq('invited_by_code', code).limit(1000);
       if (!v2.error && v2.data) rows = v2.data;
    }
  }
}
if (!rows.length) { tbody.innerHTML = '<tr><td colspan="5" class="muted small">Нет данных</td></tr>'; return; }
// балансы
const ids = rows.map(x=>x.user_id);
const balances = {};
try {
  const w = await sb.from('wallets').select('user_id,balance_cents').in('user_id', ids);
  (w.data||[]).forEach(x=>balances[x.user_id]=x.balance_cents||0);
} catch(_){}
tbody.innerHTML='';
rows.forEach(x=>{
  const tr=document.createElement('tr');
  tr.innerHTML = '<td class="nowrap">'+x.user_id+'</td>'
    + '<td>'+(x.email||'—')+'</td>'
    + '<td>'+(x.phone||'—')+'</td>'
    + '<td class="right">'+fmtCents(balances[x.user_id]||0)+'</td>'
    + '<td>'+(x.ref_code||'—')+'</td>';
  tbody.appendChild(tr);
});
window._l1Cache = rows.map(x=>({ user_id:x.user_id, email:x.email||'', phone:x.phone||'', balance_cents: balances[x.user_id]||0, ref_code:x.ref_code||'' }));
}

  document.getElementById('rLoadL1').addEventListener('click', ()=>loadL1(document.getElementById('rInviter').value.trim()));
  document.getElementById('rExportL1').addEventListener('click', ()=>exportCSV('referrals_L1.csv', window._l1Cache||[]));

  // Ref tree 1–3
  async function buildTree(){
const root = $('#treeUser').value.trim(); const tbody = $('#treeTable tbody'); tbody.innerHTML='<tr><td colspan="6" class="muted small">Загрузка…</td></tr>';
if (!root) { tbody.innerHTML='<tr><td colspan="6" class="muted small">Укажите User ID</td></tr>'; return; }
let rows=[];
// 1) Пытаемся через RPC
try {
  for (const level of [1,2,3]){
    const r=await sb.rpc('get_referrals_by_generation', { p_level:level, p_min_cents:0, p_root_user:root });
    const list=Array.isArray(r.data)?r.data:(r.data?[r.data]:[]);
    rows.push(...list.map(x=>({level,user_id:x.user_id})));
  }
} catch(_){}
// 2) Фолбэк: послойно через VIEW profiles_refs_admin
if (!rows.length) {
  let parents=[{user_id:root, ref_code:null}];
  try {
    const p = await sb.from('profiles_refs_admin').select('ref_code').eq('user_id', root).maybeSingle();
    parents[0].ref_code = p.data?.ref_code || null;
  } catch(_){}
  for (let lvl=1; lvl<=3; lvl++) {
    const parentIds = parents.map(p=>p.user_id);
    let childs = [];
    // по inviter_id
    const q1 = await sb.from('profiles_refs_admin').select('user_id,email,phone,ref_code,inviter_id,invited_by_code').in('inviter_id', parentIds).limit(2000);
    if (!q1.error && q1.data && q1.data.length) childs = q1.data;
    // по invited_by_code
    const parentCodes = parents.map(p=>p.ref_code).filter(Boolean);
    if (parentCodes.length) {
      const q2 = await sb.from('profiles_refs_admin').select('user_id,email,phone,ref_code,inviter_id,invited_by_code').in('invited_by_code', parentCodes).limit(2000);
      if (!q2.error && q2.data) {
        const seen=new Set(childs.map(c=>c.user_id));
        q2.data.forEach(c=>{ if(!seen.has(c.user_id)) childs.push(c);});
      }
    }
    if (!childs.length) break;
    rows.push(...childs.map(c=>({level:lvl, user_id:c.user_id, email:c.email, phone:c.phone, ref_code:c.ref_code})));
    parents = childs;
  }
}
if (!rows.length) { tbody.innerHTML='<tr><td colspan="6" class="muted small">Пусто</td></tr>'; window._treeCache=[]; return; }
const ids = Array.from(new Set(rows.map(r=>r.user_id)));
const bal = {};
try{
  const w = await sb.from('wallets').select('user_id,balance_cents').in('user_id', ids);
  (w.data||[]).forEach(x=>bal[x.user_id]=x.balance_cents||0);
}catch(_){}
tbody.innerHTML='';
rows.forEach(r=>{
  const tr=document.createElement('tr');
  tr.innerHTML = '<td>'+r.level+'</td><td class="nowrap">'+r.user_id+'</td><td>'+(r.email||'—')+'</td><td>'+(r.phone||'—')+'</td><td class="right">'+fmtCents(bal[r.user_id]||0)+'</td><td>'+(r.ref_code||'—')+'</td>';
  tbody.appendChild(tr);
});
window._treeCache = rows;
}

  document.getElementById('treeLoad').addEventListener('click', buildTree);
  document.getElementById('treeExport').addEventListener('click', ()=>{ const arr=(window._treeCache||[]).map(r=>({ level:r.level, user_id:r.user_id })); exportCSV('ref_tree.csv', arr); });

  // Drawer
  $('#dClose').addEventListener('click', ()=>$('#drawer').classList.remove('open'));
  async function openUserDrawer(uid){
    if(!uid) return;
    $('#drawer').classList.add('open'); $('#dTitle').textContent='Профиль: '+uid; $('#dUserId').value=uid;
    const [prof, wallet, wds, rrs] = await Promise.all([
      sb.from('profiles').select('user_id, created_at, email, phone, ref_code').eq('user_id', uid).maybeSingle(),
      sb.from('wallets').select('user_id, balance_cents').eq('user_id', uid).maybeSingle(),
      sb.from('withdrawals').select('created_at, amount_cents, status, txid').eq('user_id', uid).order('created_at', {ascending:false}).limit(20),
      sb.from('referral_rewards').select('created_at, level, amount_cents, source_user_id').eq('target_user_id', uid).order('created_at', {ascending:false}).limit(30)
    ]);
    $('#dCreated').value = prof?.data?.created_at ? new Date(prof.data.created_at).toLocaleString() : '—';
    $('#dEmail').value = prof?.data?.email || '';
    $('#dPhone').value = prof?.data?.phone || '';
    $('#dBalance').value = ((wallet?.data?.balance_cents||0)/100).toFixed(2);
    $('#dRefCode').value = prof?.data?.ref_code || '';
    $('#dRefLink').value = prof?.data?.ref_code ? buildRefLink(prof.data.ref_code) : '';

    const wtbody = $('#dWTable tbody'); wtbody.innerHTML=''; (wds?.data||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML='<td class="nowrap">'+new Date(r.created_at).toLocaleString()+'</td><td class="right">'+fmtCents(r.amount_cents||0)+'</td><td>'+String(r.status||'pending')+'</td><td class="nowrap">'+(r.txid?('<code>'+short(r.txid)+'</code>'):'—')+'</td>'; wtbody.appendChild(tr); });
    const rtbody = $('#dRTable tbody'); rtbody.innerHTML=''; (rrs?.data||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML='<td class="nowrap">'+new Date(r.created_at).toLocaleString()+'</td><td>'+r.level+'</td><td class="right">'+fmtCents(r.amount_cents||0)+'</td><td class="nowrap">'+r.source_user_id+'</td>'; rtbody.appendChild(tr); });

    $('#dCopyRef').onclick = async ()=>{ try{ await navigator.clipboard.writeText($('#dRefLink').value); alert('Скопировано'); }catch(_){}};
    $('#dSaveProfile').onclick = async ()=>{ try{ const upd=await sb.from('profiles').update({ email:$('#dEmail').value||null, phone:$('#dPhone').value||null, ref_code:$('#dRefCode').value||null }).eq('user_id', uid).select().maybeSingle(); if(upd.error) throw upd.error; alert('Сохранено'); loadUsers(); }catch(e){ alert(e.message||e); } };
    $('#dApplyDelta').onclick = async ()=>{ const delta=Number($('#dDelta').value||'0'); if(!Number.isFinite(delta)||!delta){ alert('Введите число (USDT)'); return; } try{ const r=await sb.rpc('admin_adjust_balance', { p_user_id: uid, p_delta_cents: toCents(delta) }); if(r.error) throw r.error; alert('Баланс скорректирован'); openUserDrawer(uid); loadUsers(); }catch(e){ alert(e.message||e); } };
  }

  // Utils
  function buildRefLink(code){ if(!code) return ''; try{ const url = new URL(location.origin + '/register_single.html'); url.searchParams.set('ref', code); return url.toString(); }catch(_){ return 'https://example.com/register_single.html?ref='+encodeURIComponent(code); } }
  function exportCSV(name, rows){ if(!rows||!rows.length){ alert('Нет данных'); return; } const esc=v='"'+String(v??'').replace(/"/g,'""')+'"'; }

  // Proper CSV export (fixed separate function)
  function exportCSV(name, rows){
    if(!rows||!rows.length){ alert('Нет данных'); return; }
    const keys = Object.keys(rows[0]);
    const esc = v => '"' + String(v ?? '').replace(/"/g,'""') + '"';
    const csv = [keys.join(',')].concat(rows.map(r=>keys.map(k=>esc(r[k])).join(','))).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }

  // Init
  (async function init(){ await refreshAuth(); await checkAdmin(); if(isAdmin){ loadWithdrawals(); setTimeout(loadUsers,150); setTimeout(loadRewards,300); } })();

})();
</script>
</body>
</html>
