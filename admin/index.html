<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LC • Admin (Core-aligned)</title>
  <link rel="icon" href="data:,">
  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
    (function(){
      try{
        if (!window.supabase) throw new Error('supabase.js not loaded');
        // === твои актуальные ключи (оставлены как есть) ===
        window.sb = window.supabase.createClient(
          'https://einpfuegfsilnoiareco.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpbnBmdWVnZnNpbG5vaWFyZWNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjM3NzAsImV4cCI6MjA2OTk5OTc3MH0.6wF-8yaV38LrXH6Ptm3KIO34wRklJKbNCVoqIGNKh_w',
          { auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } }
        );
        console.log('[Admin] Supabase init OK');
      } catch(e){ console.error('[Admin] Supabase init error', e); }
    })();
  </script>
  <style>
    :root{
      --bg:#f7f8fa; --panel:#ffffff; --text:#17223b; --muted:#6b7280; --accent:#2563eb;
      --ok:#10b981; --warn:#eab308; --bad:#ef4444; --line:#e5e7eb; --chip:#f3f4f6;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1280px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{font-weight:800;font-size:18px;letter-spacing:.2px}
    .authbar{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted)}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;transition:.15s}
    .btn:hover{box-shadow:0 1px 0 rgba(0,0,0,.05)}
    .btn.ok{background:#ecfdf5;border-color:#d1fae5}
    .btn.warn{background:#fffbeb;border-color:#fef3c7}
    .btn.bad{background:#fef2f2;border-color:#fee2e2}
    .btn.ghost{background:#fff}
    .btn.small{padding:5px 8px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .tab.active{background:#e8f0ff;border-color:#c7d2fe;color:#1e40af}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    input,select,textarea{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{background:#f9fafb;border-bottom:1px solid var(--line);padding:10px;text-align:left;white-space:nowrap}
    td{border-top:1px solid var(--line);padding:10px;vertical-align:top}
    .right{text-align:right}
    .chip{display:inline-block;background:var(--chip);border:1px solid var(--line);padding:3px 8px;border-radius:999px;font-size:12px}
    .pill{padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
    .pill.paid{background:#ecfdf5;border-color:#d1fae5;color:#065f46}
    .pill.pending{background:#eff6ff;border-color:#dbeafe;color:#1e40af}
    .pill.rejected{background:#fef2f2;border-color:#fee2e2;color:#991b1b}
    .cards{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-bottom:10px}
    .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .card .k{font-size:12px;color:var(--muted)}
    .card .v{font-weight:700;font-size:16px}
    .drawer{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-end;justify-content:flex-end}
    .drawer.open{display:flex}
    .drawer .sheet{width:560px;max-width:92vw;height:100%;overflow:auto;background:#fff;border-left:1px solid var(--line);padding:16px}
    .small{font-size:12px}
    .nowrap{white-space:nowrap}
    h3{margin:6px 0 8px}
    .hidden{display:none !important}
    @media (max-width:900px){ .cards{grid-template-columns:repeat(2,minmax(0,1fr));} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">LC • Admin</div>
    <div class="authbar">
      <span class="muted small">Аккаунт:</span>
      <span id="authInfo" class="nowrap">—</span>
      <button class="btn" id="btnLogin">Войти</button>
      <button class="btn" id="btnLogout" style="display:none">Выйти</button>
    </div>
  </div>

  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="withdrawals">Заявки</button>
    <button class="tab" data-tab="users">Пользователи</button>
    <button class="tab" data-tab="refs">Рефералы</button>
    <button class="tab" data-tab="rewards">Начисления</button>
    <button class="tab" data-tab="deposits">Пополнения</button>
    <button class="tab" data-tab="about">Справка</button>
  </div>

  <!-- WITHDRAWALS -->
  <section class="panel" data-page="withdrawals">
    <div class="cards">
      <div class="card"><div class="k">Всего (отфильтровано)</div><div id="wCount" class="v">—</div></div>
      <div class="card"><div class="k">Сумма заявок</div><div id="wSum" class="v">—</div></div>
      <div class="card"><div class="k">Комиссии</div><div id="wFee" class="v">—</div></div>
      <div class="card"><div class="k">Итого к выплате</div><div id="wTotal" class="v">—</div></div>
    </div>

    <div class="row">
      <select id="wStatus">
        <option value="">Все статусы</option>
        <option value="pending">Ожидание</option>
        <option value="paid">Оплачено</option>
        <option value="rejected">Отклонено</option>
      </select>
      <input id="wSearch" class="grow" placeholder="Поиск: id, адрес, TX, email, телефон">
      <input id="wFrom" type="date" title="с даты">
      <input id="wTo" type="date" title="по дату">
      <input id="wAmtMin" type="number" step="0.01" placeholder="мин USDT" style="width:120px">
      <input id="wAmtMax" type="number" step="0.01" placeholder="макс USDT" style="width:120px">
      <button class="btn" id="wReload">Обновить</button>
      <button class="btn ghost" id="wExport">Экспорт CSV</button>
    </div>

    <div class="table-wrap" style="margin-top:8px">
      <table id="wTable">
        <thead><tr>
          <th>ID</th><th>Создано</th><th>Email</th><th>Телефон</th>
          <th class="right">Сумма</th><th class="right">Комиссия</th><th class="right">Итого</th>
          <th>Сеть</th><th>Адрес</th><th>Статус</th><th>TX/Примечание</th><th></th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="muted small" id="wDiag">—</span>
      <span class="grow"></span>
      <button class="btn ghost" id="wPrev">Назад</button>
      <button class="btn ghost" id="wNext">Вперёд</button>
    </div>
  </section>

  <!-- USERS -->
  <section class="panel" data-page="users" style="display:none">
    <div class="cards">
      <div class="card"><div class="k">Пользователей (отфильтр.)</div><div id="uCount" class="v">—</div></div>
      <div class="card"><div class="k">Сумма балансов</div><div id="uSumBal" class="v">—</div></div>
      <div class="card"><div class="k">Средний баланс</div><div id="uAvgBal" class="v">—</div></div>
      <div class="card"><div class="k">С ref-кодом</div><div id="uWithRef" class="v">—</div></div>
    </div>
    <div class="row">
      <input id="uSearch" class="grow" placeholder="Поиск: email, телефон, user_id, ref_code">
      <input id="uBalMin" type="number" step="0.01" placeholder="баланс ≥ USDT" style="width:150px">
      <input id="uBalMax" type="number" step="0.01" placeholder="баланс ≤ USDT" style="width:150px">
      <button class="btn" id="uReload">Обновить</button>
      <button class="btn ghost" id="uExport">Экспорт CSV</button>
      <span class="muted small" id="uDiag">—</span>
    </div>
    <div class="table-wrap" style="margin-top:8px">
      <table id="uTable">
        <thead><tr>
          <th>ID</th><th>Создано</th><th>Email</th><th>Телефон</th>
          <th class="right">Баланс</th><th>Реф-код</th><th>Реф-ссылка</th><th></th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- REFS -->
  <section class="panel" data-page="refs" style="display:none">
    <div class="row">
      <input id="rInviter" class="grow" placeholder="User ID или РЕФ-КОД (показать L1)">
      <button class="btn" id="rLoadL1">Показать L1</button>
      <button class="btn ghost" id="rExportL1">Экспорт L1</button>
    </div>
    <div class="table-wrap" style="margin-top:8px">
      <table id="rL1Table">
        <thead><tr><th>User ID</th><th>Email</th><th>Телефон</th><th class="right">Баланс</th><th>Реф-код</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="row" style="margin-top:12px">
      <input id="treeUser" class="grow" placeholder="User ID или РЕФ-КОД (дерево 1–3)">
      <button class="btn" id="treeLoad">Построить 1–3</button>
      <button class="btn ghost" id="treeExport">Экспорт дерева</button>
    </div>
    <div class="table-wrap" style="margin-top:8px">
      <table id="treeTable">
        <thead><tr><th>Уровень</th><th>User ID</th><th>Email</th><th>Телефон</th><th class="right">Баланс</th><th>Реф-код</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- REWARDS -->
  <section class="panel" data-page="rewards" style="display:none">
    <div class="cards">
      <div class="card"><div class="k">Записей (отфильтр.)</div><div id="rwCount" class="v">—</div></div>
      <div class="card"><div class="k">Сумма начислений</div><div id="rwSum" class="v">—</div></div>
      <div class="card"><div class="k">L1 / L2 / L3</div><div id="rwByLvl" class="v">—</div></div>
      <div class="card"><div class="k">Период</div><div id="rwRange" class="v">—</div></div>
    </div>
    <div class="row">
      <select id="rwLevel">
        <option value="">Уровень: все</option>
        <option value="0">0</option><option value="1">1</option>
        <option value="2">2</option><option value="3">3</option>
      </select>
      <input id="rwFrom" type="date" title="с даты">
      <input id="rwTo" type="date" title="по дату">
      <input id="rwSearch" class="grow" placeholder="Поиск: target_user, source_user, заметка">
      <button class="btn" id="rwReload">Обновить</button>
      <button class="btn ghost" id="rwExport">Экспорт CSV</button>
      <span class="muted small" id="rwDiag">—</span>
    </div>
    <div class="table-wrap" style="margin-top:8px">
      <table id="rwTable">
        <thead><tr>
          <th>Дата</th><th>Уровень</th><th>Получатель</th><th>Источник</th><th class="right">Сумма</th><th>Комментарий</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ABOUT -->
  <section class="panel" data-page="about" style="display:none">
    <h3>Справка</h3>
    <p class="small muted">
      Источники (CORE): <code>v_admin_profiles</code>, <code>wallets</code>, <code>v_admin_rewards</code>, (опц.) <code>v_admin_rewards_totals</code>. RPC: <code>lc_is_admin</code>, <code>admin_list_users</code>, <code>admin_get_ref_tree</code>, <code>admin_balances_by_user_ids</code>, (опц.) <code>admin_update_withdrawal</code>, <code>admin_adjust_balance</code>.<br>
      Баланс канонический: <code>wallets.balance_cents</code>. Админ-панель не меняет схему сайта.
    </p>
  </section>
</div>

<!-- Drawer -->
<div class="drawer" id="drawer">
  <div class="sheet">
    <div class="row" style="justify-content:space-between">
      <h3 id="dTitle" style="margin:6px 0">Профиль пользователя</h3>
      <button class="btn" id="dCopyUID">Copy ID</button>
      <button class="btn ghost" id="dClose">Закрыть</button>
    </div>
    <div class="row">
      <div class="grow">
        <div class="small muted">User ID</div><input id="dUserId" class="grow" readonly>
      </div>
      <div class="grow">
        <div class="small muted">Создан</div><input id="dCreated" class="grow" readonly>
      </div>
    </div>
    <div class="row">
      <div class="grow"><div class="small muted">Email</div><input id="dEmail" class="grow"></div>
      <div class="grow"><div class="small muted">Телефон</div><input id="dPhone" class="grow"></div>
    </div>
    <div class="row">
      <div class="grow"><div class="small muted">Баланс (USDT)</div><input id="dBalance" type="number" step="0.01" class="grow" readonly></div>
      <div class="grow"><div class="small muted">Реф-код</div><input id="dRefCode" class="grow"></div>
    </div>
    <div class="row">
      <div class="grow"><div class="small muted">Реф-ссылка</div><input id="dRefLink" class="grow" readonly></div>
      <button class="btn" id="dCopyRef">Копировать</button>
    </div>

    <div id="deltaRow" class="row hidden" style="margin-top:6px">
      <div class="grow"><div class="small muted">Изменение (±USDT)</div><input id="dDelta" type="number" step="0.01" class="grow" placeholder="например, 15 или -7.5"></div>
      <button class="btn warn" id="dApplyDelta">Применить</button>
      <button class="btn ok" id="dSaveProfile">Сохранить</button>
    </div>

    <h3 style="margin-top:12px">Свод начислений (по профилю)</h3>
    <div class="cards" style="margin-top:6px">
      <div class="card"><div class="k">Итого</div><div id="dRwAll" class="v">—</div></div>
      <div class="card"><div class="k">L1</div><div id="dRwL1" class="v">—</div></div>
      <div class="card"><div class="k">L2</div><div id="dRwL2" class="v">—</div></div>
      <div class="card"><div class="k">L3</div><div id="dRwL3" class="v">—</div></div>
    </div>

    <h3>Заявки пользователя</h3>
    <div class="table-wrap">
      <table id="dWTable"><thead><tr><th>Дата</th><th>Сумма</th><th>Статус</th><th>TX</th></tr></thead><tbody></tbody></table>
    </div>
    <h3>Реферальные начисления</h3>
    <div class="table-wrap">
      <table id="dRTable"><thead><tr><th>Дата</th><th>Уровень</th><th>Сумма</th><th>Источник</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script>
(function(){

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const sb = window.sb;
  if (!sb) { alert('Supabase не инициализирован'); }
  const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpbnBmdWVnZnNpbG5vaWFyZWNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjM3NzAsImV4cCI6MjA2OTk5OTc3MH0.6wF-8yaV38LrXH6Ptm3KIO34wRklJKbNCVoqIGNKh_w';
  const fmtCents = c => ((+c||0)/100).toLocaleString('ru-RU', {minimumFractionDigits:0, maximumFractionDigits:2}) + ' USDT';
  const pill = s => '<span class="pill '+s+'">'+(s==='paid'?'оплачено':s==='rejected'?'отклонено':'ожидание')+'</span>';
  const short = s => (s ? String(s).slice(0,6)+'…'+String(s).slice(-4) : '');
  const toCents = v => Math.round((Number(v)||0) * 100);
  const qlike = v => v? '%' + String(v).toLowerCase().trim() + '%' : null;
  const isUUID = (s) => /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(String(s||''));

  // Универсальный fetch RPC, возвращает JS-объект или бросает Error с body
  async function callRpcFetch(name, params){
    const url = new URL('/rest/v1/rpc/' + encodeURIComponent(name), location.origin.replace(/https?:\/\/[^/]+/, 'https://einpfuegfsilnoiareco.supabase.co'));
    // build full url from supabase URL explicitly to avoid relative issues
    const fullUrl = 'https://einpfuegfsilnoiareco.supabase.co/rest/v1/rpc/' + encodeURIComponent(name);
    const headers = {
      'Content-Type': 'application/json',
      'apikey': ANON_KEY,
      'Authorization': 'Bearer ' + ANON_KEY,
      'Accept': 'application/json'
    };
    let body = {};
    if (params && typeof params === 'object') body = params;
    try {
      const res = await fetch(fullUrl, { method: 'POST', headers, body: JSON.stringify(body), credentials: 'omit' });
      const text = await res.text();
      // try parse json
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch(e){}
      if (!res.ok) {
        // show more detail to user for debugging
        const message = (data && data.message) ? data.message : text || res.statusText;
        // show in console and alert so admin sees it
        console.error('RPC ' + name + ' failed', res.status, text, data);
        alert('RPC ' + name + ' error: ' + message);
        throw new Error(message);
      }
      return data;
    } catch (e) {
      console.error('callRpcFetch error', e);
      throw e;
    }
  }

  let sessionUser = null, isAdmin = false, hasAdjust=false;

  // Tabs
  $$('#tabs .tab').forEach(btn => {
    btn.addEventListener('click', () => {
      $$('#tabs .tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      $$('[data-page]').forEach(p => p.style.display = (p.getAttribute('data-page') === tab) ? 'block' : 'none');
      if (tab === 'withdrawals') loadWithdrawals(true);
      if (tab === 'users') loadUsers();
      if (tab === 'rewards') loadRewards();
    });
  });

  // Auth
  async function refreshAuth(){
    const { data: { session } } = await sb.auth.getSession();
    sessionUser = session?.user || null;
    $('#authInfo').textContent = sessionUser ? (sessionUser.email || sessionUser.id) : 'не авторизованы';
    $('#btnLogin').style.display = sessionUser ? 'none':'inline-block';
    $('#btnLogout').style.display = sessionUser ? 'inline-block':'none';
  }
  $('#btnLogin').addEventListener('click', async () => {
    try{
      const email = prompt('Email для входа:'); if(!email) return;
      const pwd = prompt('Пароль (пусто — magic-link):') || '';
      if(pwd){
        const { error } = await sb.auth.signInWithPassword({ email, password: pwd });
        if(error){ alert('Ошибка: '+(error.message||error)); return; }
        location.reload();
      } else {
        const { error } = await sb.auth.signInWithOtp({ email, options: { emailRedirectTo: location.href } });
        if(error){ alert('Ошибка отправки ссылки: '+(error.message||error)); return; }
        alert('Ссылка для входа отправлена на email.');
      }
    }catch(e){ alert(e.message||e); }
  });
  $('#btnLogout').addEventListener('click', async ()=>{ await sb.auth.signOut(); location.reload(); });

  async function checkAdmin(){
    isAdmin = false;
    try {
      const r = await sb.rpc('lc_is_admin');
      if (!r?.error) {
        const row = Array.isArray(r.data) ? r.data[0] : r.data;
        if (row === true || row?.is_admin === true) isAdmin = true;
      }
    } catch(_) {}
    if (!isAdmin) {
      try{
        const { data: { user } } = await sb.auth.getUser();
        if (user) {
          const q = await sb.from('admins').select('user_id').eq('user_id', user.id).maybeSingle();
          if (!q.error && q.data?.user_id) isAdmin = true;
        }
      }catch(_){}
    }
    if (!isAdmin) {
      alert('Доступ запрещён: вы не администратор.');
      $$('#tabs .tab').forEach(b=>b.disabled=true);
    }
  }

  // Capability: admin_adjust_balance?
  async function detectAdjust(){
    try{
      const r = await sb.rpc('admin_adjust_balance', { p_user_id:'00000000-0000-0000-0000-000000000000', p_delta_cents: 0 });
      hasAdjust = !r || !r.error ? true : false;
    }catch(_){ hasAdjust=false; }
  }

let wPage = 0, wLimit = 25, wLastCount = 0, wRowsCache = [];
async function loadWithdrawals(resetPage){
  if (!isAdmin) return;
  if (resetPage) wPage = 0;

  const tbody = $('#wTable tbody');
  if (!tbody) return;
  tbody.innerHTML = '<tr><td colspan="12" class="muted small">Загрузка…</td></tr>';

  const status = $('#wStatus').value || null;
  const s = ($('#wSearch').value || '').trim() || null;
  const from = $('#wFrom').value ? new Date($('#wFrom').value) : null;
  const to = $('#wTo').value ? new Date($('#wTo').value) : null;
  const min = $('#wAmtMin').value ? toCents($('#wAmtMin').value) : null;
  const max = $('#wAmtMax').value ? toCents($('#wAmtMax').value) : null;

  const params = {
    p_status: status || null,
    p_search: s || null,
    p_from: from ? from.toISOString() : null,
    p_to: to ? to.toISOString() : null,
    p_min: min,
    p_max: max,
    p_offset: wPage * wLimit,
    p_limit: wLimit
  };

  let rows = [];
  try {
    const r = await sb.rpc('admin_list_withdrawals', params);
    if (r?.error) {
      tbody.innerHTML = '<tr><td colspan="12" class="small" style="color:#b91c1c">' + (r.error.message || JSON.stringify(r.error)) + '</td></tr>';
      return;
    }
    rows = Array.isArray(r.data) ? r.data : (r.data ? [r.data] : []);
    wRowsCache = rows;

    // Попытка получить точный count (если есть RPC)
    try {
      const c = await sb.rpc('admin_list_withdrawals_count', {
        p_status: status || null, p_search: s || null,
        p_from: from ? from.toISOString() : null, p_to: to ? to.toISOString() : null,
        p_min: min, p_max: max
      });
      if (!c?.error) {
        const cnt = (typeof c.data === 'number') ? c.data : (Array.isArray(c.data) ? Number(c.data[0]) : Number(c.data));
        if (!Number.isNaN(cnt)) wLastCount = cnt;
      }
    } catch(_) { /* ignore */ }

    if (!wLastCount) {
      if (rows.length < wLimit) wLastCount = wPage * wLimit + rows.length;
      else wLastCount = (wPage + 1) * wLimit + 1;
    }
    $('#wDiag').textContent = 'Страница ' + (wPage + 1) + ' · ' + wLastCount + ' записей';

  } catch (err) {
    tbody.innerHTML = '<tr><td colspan="12" class="small" style="color:#b91c1c">' + (err?.message || String(err)) + '</td></tr>';
    return;
  }

  // Подгружаем профили (email/phone) — заранее
  const emailByUser = {}, phoneByUser = {};
  try {
    const ids = Array.from(new Set(rows.map(r => r.user_id).filter(Boolean)));
    if (ids.length) {
      const profRes = await sb.from('profiles').select('user_id,email,phone').in('user_id', ids);
      if (!profRes.error && profRes.data && profRes.data.length) {
        profRes.data.forEach(p => { emailByUser[p.user_id] = p.email; phoneByUser[p.user_id] = p.phone; });
      }
    }
  } catch (e) {
    console.warn('profiles lookup failed', e);
  }

  // Рендер таблицы
  try {
    if (!rows || !rows.length) {
      tbody.innerHTML = '<tr><td colspan="12" class="muted small">Нет записей.</td></tr>';
      $('#wCount').textContent = '0';
      $('#wSum').textContent = fmtCents(0);
      $('#wFee').textContent = fmtCents(0);
      $('#wTotal').textContent = fmtCents(0);
      return;
    }

    tbody.innerHTML = '';
    let sumAmt = 0, sumFee = 0;
    for (const r of rows) {
      const amount = Number(r.amount_cents || 0);
      const fee = Number(r.fee_cents || 0);
      const total = amount + fee;
      sumAmt += amount; sumFee += fee;

      const tr = document.createElement('tr');
      tr.innerHTML =
        '<td class="nowrap small">' + (r.id || '') + '</td>' +
        '<td class="nowrap small">' + (r.created_at ? new Date(r.created_at).toLocaleString() : '') + '</td>' +
        '<td class="small">' + (emailByUser[r.user_id] || short(r.user_id) || '—') + '</td>' +
        '<td class="small">' + (phoneByUser[r.user_id] || '—') + '</td>' +
        '<td class="right small">' + fmtCents(amount) + '</td>' +
        '<td class="right small">' + fmtCents(fee) + '</td>' +
        '<td class="right small">' + fmtCents(total) + '</td>' +
        '<td class="small">' + (r.network || '—') + '</td>' +
        '<td class="small nowrap">' + (r.address ? ('<code>' + r.address + '</code>') : '—') + '</td>' +
        '<td class="small">' + (r.status ? pill(String(r.status).toLowerCase()) : pill('pending')) + '</td>' +
        '<td class="small">' + (r.txid ? ('<code>' + short(r.txid) + '</code>') : (r.note ? ('<div class="small muted">' + r.note + '</div>') : '—')) + '</td>' +
        '<td class="nowrap small">' +
          '<button class="btn ok small" data-act="pay" data-id="'+r.id+'">Оплатить</button> ' +
          '<button class="btn bad small" data-act="reject" data-id="'+r.id+'">Отклонить</button> ' +
          '<button class="btn ghost small" data-act="view" data-user="'+r.user_id+'">Профиль</button>' +
        '</td>';
      tbody.appendChild(tr);
    }

    // Привязка делегированного обработчика к tbody (однократно)
    if (!tbody._btnDelegated) {
      tbody._btnDelegated = true;
      tbody.addEventListener('click', async (ev) => {
        try {
          const btn = ev.target && ev.target.closest ? ev.target.closest('button[data-act]') : null;
          if (!btn) return;
          // предотвращаем стандартную обработку если нужно
          ev.preventDefault();
          const act = (btn.getAttribute('data-act') || '').trim();
          const id = btn.getAttribute('data-id') || null;
          const user = btn.getAttribute('data-user') || null;

          if (act === 'view') {
            if (typeof openUserDrawer === 'function') {
              openUserDrawer(user || id);
            } else {
              console.warn('openUserDrawer not defined');
              alert('Функция открытия профиля недоступна');
            }
            return;
          }

          if (act === 'pay' || act === 'reject') {
            if (!id) { alert('Неизвестный ID заявки'); return; }
            // подтверждение
            const confirmed = confirm(act === 'pay' ? 'Отметить заявку как оплаченную?' : 'Отклонить заявку?');
            if (!confirmed) return;

            // сначала пытаемся вызвать существующую функцию markWithdrawal (сохранение поведения)
            if (typeof markWithdrawal === 'function') {
              try {
                await markWithdrawal(id, act === 'pay' ? 'paid' : 'rejected');
                if (typeof loadWithdrawals === 'function') loadWithdrawals(false);
                return;
              } catch (err) {
                console.warn('markWithdrawal failed, falling back to RPC', err);
              }
            }

            // fallback — вызываем RPC-функции (через fetch, чтобы видеть текст ошибки)
            try {
              if (act === 'pay') {
                const tx = prompt('Введите TXID (опционально):') || null;
                await callRpcFetch('admin_pay_withdrawal', { p_id: id, p_txid: tx });
              } else {
                const note = prompt('Причина отклонения (опционально):') || null;
                await callRpcFetch('admin_reject_withdrawal', { p_id: id, p_note: note });
              }
              if (typeof loadWithdrawals === 'function') loadWithdrawals(false);
            } catch (rpcErr) {
              console.error('RPC error', rpcErr);
              // callRpcFetch уже покажет alert с телом ошибки
            }
            return;
          }
        } catch (e) {
          console.error('tbody click handler error', e);
        }
      });
    }

    $('#wCount').textContent = String(rows.length);
    $('#wSum').textContent = fmtCents(sumAmt);
    $('#wFee').textContent = fmtCents(sumFee);
    $('#wTotal').textContent = fmtCents(sumAmt + sumFee);

  } catch (e) {
    tbody.innerHTML = '<tr><td colspan="12" class="small" style="color:#b91c1c">' + (e?.message || String(e)) + '</td></tr>';
    return;
  }
}

  // ===================== USERS =====================
  let uRowsCache=[];
  async function loadUsers(){
    if (!isAdmin) return;
    const tbody = $('#uTable tbody'); tbody.innerHTML = '<tr><td colspan="8" class="muted small">Загрузка…</td></tr>';
    const s = $('#uSearch').value.trim();
    const balMin = $('#uBalMin').value ? toCents($('#uBalMin').value) : null;
    const balMax = $('#uBalMax').value ? toCents($('#uBalMax').value) : null;
    let rows=null;

    // 1) Предпочтительно: admin_list_users(p_search)
    try {
      const r = await sb.rpc('admin_list_users', { p_search: s || null });
      if(!r.error){
        const list = Array.isArray(r.data)? r.data : (r.data? [r.data] : []);
        rows = list.map(x=>({
          user_id:x.user_id, created_at:x.activated_at || x.created_at,
          email:x.email, phone:x.phone, ref_code:x.ref_code,
          balance_cents:x.balance_cents ?? 0
        }));
      }
    } catch(_){}

    // 2) Фолбэк: v_admin_profiles + wallets
    if (!rows){
      let q = sb.from('v_admin_profiles').select('user_id, email, phone, ref_code, invited_by_code, created_at').order('created_at', {ascending:false}).limit(1000);
      if (s) { const like=qlike(s); q = q.or('user_id.ilike.'+like+',email.ilike.'+like+',phone.ilike.'+like+',ref_code.ilike.'+like); }
      const r = await q; if (r.error) { tbody.innerHTML='<tr><td colspan="8" class="small" style="color:#b91c1c">'+(r.error.message||r.error)+'</td></tr>'; return; }
      const ids = (r.data||[]).map(p=>p.user_id);
      let balances={}; if (ids.length) { const w = await sb.from('wallets').select('user_id, balance_cents').in('user_id', ids); (w.data||[]).forEach(x=>balances[x.user_id]=x.balance_cents||0); }
      rows = (r.data||[]).map(p=>({ user_id:p.user_id, created_at:p.created_at, email:p.email, phone:p.phone, ref_code:p.ref_code, balance_cents: balances[p.user_id]||0 }));
    }

    // фильтр по балансу (клиентский)
    if (balMin!=null || balMax!=null){
      rows = (rows||[]).filter(r => (balMin==null || r.balance_cents>=balMin) && (balMax==null || r.balance_cents<=balMax));
    }

    uRowsCache = rows||[];
    const sumBal = uRowsCache.reduce((a,b)=>a+(+b.balance_cents||0),0);
    $('#uCount').textContent = uRowsCache.length;
    $('#uSumBal').textContent = fmtCents(sumBal);
    $('#uAvgBal').textContent = uRowsCache.length? fmtCents(Math.round(sumBal/uRowsCache.length)) : '—';
    $('#uWithRef').textContent = uRowsCache.filter(r=>!!r.ref_code).length;

    $('#uDiag').textContent = uRowsCache.length+' пользователей';
    tbody.innerHTML=''; if(!uRowsCache.length){ tbody.innerHTML='<tr><td colspan="8" class="muted small">Пусто</td></tr>'; return; }
    for (const r of uRowsCache) {
      const link = buildRefLink(r.ref_code);
      const tr = document.createElement('tr');
      tr.innerHTML = '<td class="nowrap">'+r.user_id+'</td>'
        + '<td class="nowrap">'+(r.created_at?new Date(r.created_at).toLocaleString():'—')+'</td>'
        + '<td>'+(r.email||'—')+'</td>'
        + '<td>'+(r.phone||'—')+'</td>'
        + '<td class="right">'+fmtCents(r.balance_cents||0)+'</td>'
        + '<td>'+(r.ref_code||'—')+'</td>'
        + '<td class="nowrap">'+(link?('<code>'+link+'</code>'):'—')+'</td>'
        + '<td class="nowrap"><button class="btn ghost small" data-open="'+r.user_id+'">Открыть</button></td>';
      tbody.appendChild(tr);
    }
  }
  $('#uReload').addEventListener('click', loadUsers);
  $('#uTable').addEventListener('click', e=>{ const btn=e.target.closest('button[data-open]'); if(!btn) return; openUserDrawer(btn.dataset.open); });
  $('#uExport').addEventListener('click', ()=>exportCSV('users.csv', uRowsCache));

  // ===================== REWARDS =====================
  let rwRowsCache=[];
  async function loadRewards(){
    if (!isAdmin) return;
    const tbody = $('#rwTable tbody'); tbody.innerHTML = '<tr><td colspan="6" class="muted small">Загрузка…</td></tr>';
    const s = $('#rwSearch').value.trim();
    const lvl = $('#rwLevel').value;
    const from = $('#rwFrom').value ? new Date($('#rwFrom').value) : null;
    const to = $('#rwTo').value ? new Date($('#rwTo').value) : null;

    // УБРАЛ amount_usd и reward_usdt — чтобы избежать 400 если этих колонок нет
    let q = sb.from('v_admin_rewards').select('created_at, level, target_user_id, source_user_id, amount_cents, note').order('created_at', {ascending:false}).limit(1000);
    if (s) { const like=qlike(s); q = q.or('target_user_id.ilike.'+like+',source_user_id.ilike.'+like+',note.ilike.'+like); }
    if (lvl!=='') q = q.eq('level', Number(lvl));
    if (from) q = q.gte('created_at', from.toISOString());
    if (to) q = q.lte('created_at', to.toISOString());

    const r = await q;
    if (r.error){ tbody.innerHTML='<tr><td colspan="6" class="small" style="color:#b91c1c">'+(r.error.message||r.error)+'</td></tr>'; return; }

    // нормализация amount — теперь только amount_cents
    let rows = (r.data||[]).map(x=>{
      let amount = x.amount_cents || 0;
      return { created_at:x.created_at, level:x.level, target_user_id:x.target_user_id, source_user_id:x.source_user_id, amount_cents:amount, note:x.note };
    });

    rwRowsCache = rows||[];

    // своды
    const sumAll = rwRowsCache.reduce((a,b)=>a+(+b.amount_cents||0),0);
    const sumL1 = rwRowsCache.filter(x=>+x.level===1).reduce((a,b)=>a+(+b.amount_cents||0),0);
    const sumL2 = rwRowsCache.filter(x=>+x.level===2).reduce((a,b)=>a+(+b.amount_cents||0),0);
    const sumL3 = rwRowsCache.filter(x=>+x.level===3).reduce((a,b)=>a+(+b.amount_cents||0),0);
    $('#rwCount').textContent = rwRowsCache.length;
    $('#rwSum').textContent = fmtCents(sumAll);
    $('#rwByLvl').textContent = [sumL1,sumL2,sumL3].map(x=>((x/100)||0).toLocaleString('ru-RU',{maximumFractionDigits:2})).join(' / ') + ' USDT';
    $('#rwRange').textContent = (from?$('#rwFrom').value:'∞') + ' → ' + (to?$('#rwTo').value:'∞');
    $('#rwDiag').textContent = rwRowsCache.length+' записей';

    tbody.innerHTML=''; if(!rwRowsCache.length){ tbody.innerHTML='<tr><td colspan="6" class="muted small">Пусто</td></tr>'; return; }
    for (const x of rwRowsCache) {
      const tr=document.createElement('tr');
      tr.innerHTML = '<td class="nowrap">'+new Date(x.created_at).toLocaleString()+'</td>'
        + '<td>'+(x.level ?? '—')+'</td>'
        + '<td class="nowrap">'+x.target_user_id+'</td>'
        + '<td class="nowrap">'+(x.source_user_id || '—')+'</td>'
        + '<td class="right">'+fmtCents(x.amount_cents||0)+'</td>'
        + '<td>'+(x.note||'—')+'</td>';
      tbody.appendChild(tr);
    }
  }
  $('#rwReload').addEventListener('click', loadRewards);
  $('#rwExport').addEventListener('click', ()=>exportCSV('rewards.csv', rwRowsCache));
  try{ sb.channel('adm-rw').on('postgres_changes', { event:'*', schema:'public', table:'v_admin_rewards' }, ()=>{ if($('.tab.active')?.dataset.tab==='rewards') loadRewards(); }).subscribe(); }catch(_){}

  // ===================== REFS =====================
  async function adminGetRefTree(rootUserId){
    try{
      const r = await sb.rpc('admin_get_ref_tree', { p_user_id: rootUserId });
      if (!r.error) return Array.isArray(r.data)? r.data : (r.data? [r.data] : []);
    }catch(_){}
    return null;
  }

  async function loadL1ByKey(key){
    const tbody = $('#rL1Table tbody'); tbody.innerHTML = '<tr><td colspan="5" class="muted small">Загрузка…</td></tr>';
    key = (key||'').trim();
    if(!key){ tbody.innerHTML = '<tr><td colspan="5" class="muted small">Укажите User ID или реф-код</td></tr>'; return; }

    // Если пришёл ref_code → найдём его user_id
    let rootId = key;
    if(!isUUID(key)){
      try{
        const p = await sb.from('v_admin_profiles').select('user_id').eq('ref_code', key).maybeSingle();
        if (p?.data?.user_id) rootId = p.data.user_id;
      }catch(_){}
    }

    let rows = [];
    const tree = isUUID(rootId) ? await adminGetRefTree(rootId) : null;
    if (tree && tree.length){
      rows = tree.filter(x=>String(x.gen) === '1').map(x=>({ user_id:x.user_id }));
    }
    if (!rows.length){
      let v1 = await sb.from('v_admin_profiles').select('user_id,email,phone,ref_code').eq('inviter_user_id', rootId).limit(1000);
      if (!v1.error && v1.data?.length) rows = v1.data;
      else if (!isUUID(key)) {
        const v2 = await sb.from('v_admin_profiles').select('user_id,email,phone,ref_code').eq('invited_by_code', key).limit(1000);
        if (!v2.error && v2.data) rows = v2.data;
      }
    }

    if (!rows.length){ tbody.innerHTML = '<tr><td colspan="5" class="muted small">Нет данных</td></tr>'; window._l1Cache=[]; return; }

    const ids = rows.map(x=>x.user_id);
    const balances = {};
    try {
      const w = await sb.rpc('admin_balances_by_user_ids', { p_ids: ids });
      (w.data||[]).forEach(x=>balances[x.user_id]=x.balance_cents||0);
    }catch(_){
      try{
        const ww = await sb.from('wallets').select('user_id,balance_cents').in('user_id', ids);
        (ww.data||[]).forEach(x=>balances[x.user_id]=x.balance_cents||0);
      }catch(_){}
    }

    tbody.innerHTML='';
    rows.forEach(x=>{
      const tr=document.createElement('tr');
      tr.innerHTML = '<td class="nowrap">'+x.user_id+'</td>'
        + '<td>'+(x.email||'—')+'</td>'
        + '<td>'+(x.phone||'—')+'</td>'
        + '<td class="right">'+fmtCents(balances[x.user_id]||0)+'</td>'
        + '<td>'+(x.ref_code||'—')+'</td>';
      tbody.appendChild(tr);
    });
    window._l1Cache = rows.map(x=>({ user_id:x.user_id, email:x.email||'', phone:x.phone||'', balance_cents: balances[x.user_id]||0, ref_code:x.ref_code||'' }));
  }
  $('#rLoadL1').addEventListener('click', ()=>loadL1ByKey($('#rInviter').value.trim()));
  $('#rExportL1').addEventListener('click', ()=>exportCSV('referrals_L1.csv', window._l1Cache||[]));

  async function buildTreeByKey(){
    const key = $('#treeUser').value.trim();
    const tbody = $('#treeTable tbody'); tbody.innerHTML='<tr><td colspan="6" class="muted small">Загрузка…</td></tr>';
    if(!key){ tbody.innerHTML='<tr><td colspan="6" class="muted small">Укажите User ID или реф-код</td></tr>'; return; }

    let rootId = key;
    if(!isUUID(key)){
      try{
        const p = await sb.from('v_admin_profiles').select('user_id').eq('ref_code', key).maybeSingle();
        if (p?.data?.user_id) rootId = p.data.user_id;
      }catch(_){}
    }

    let rows = [];
    const tree = isUUID(rootId) ? await adminGetRefTree(rootId) : null;
    if (tree && tree.length){
      rows = tree.map(x=>({ level:x.gen, user_id:x.user_id }));
    } else {
      // Фолбэк: послойно через v_admin_profiles
      let parents=[{user_id:rootId, ref_code:null}];
      try { const p = await sb.from('v_admin_profiles').select('ref_code').eq('user_id', rootId).maybeSingle();
            parents[0].ref_code = p?.data?.ref_code || null; } catch(_){}
      for (let lvl=1; lvl<=3; lvl++) {
        const parentIds = parents.map(p=>p.user_id);
        let childs = [];
        const q1 = await sb.from('v_admin_profiles').select('user_id,email,phone,ref_code,inviter_user_id,invited_by_code').in('inviter_user_id', parentIds).limit(2000);
        if (!q1.error && q1.data?.length) childs = q1.data;
        const parentCodes = parents.map(p=>p.ref_code).filter(Boolean);
        if (parentCodes.length) {
          const q2 = await sb.from('v_admin_profiles').select('user_id,email,phone,ref_code,inviter_user_id,invited_by_code').in('invited_by_code', parentCodes).limit(2000);
          if (!q2.error && q2.data) {
            const seen=new Set(childs.map(c=>c.user_id));
            q2.data.forEach(c=>{ if(!seen.has(c.user_id)) childs.push(c);});
          }
        }
        if (!childs.length) break;
        rows.push(...childs.map(c=>({level:lvl, user_id:c.user_id, email:c.email, phone:c.phone, ref_code:c.ref_code})));
        parents = childs;
      }
    }

    if (!rows.length) { tbody.innerHTML='<tr><td colspan="6" class="muted small">Пусто</td></tr>'; window._treeCache=[]; return; }

    const ids = Array.from(new Set(rows.map(r=>r.user_id)));
    const bal = {};
    try{
      const w = await sb.rpc('admin_balances_by_user_ids', { p_ids: ids });
      (w.data||[]).forEach(x=>bal[x.user_id]=x.balance_cents||0);
    }catch(_){
      try{
        const ww = await sb.from('wallets').select('user_id,balance_cents').in('user_id', ids);
        (ww.data||[]).forEach(x=>bal[x.user_id]=x.balance_cents||0);
      }catch(_){}
    }

    tbody.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = '<td>'+r.level+'</td>'
        + '<td class="nowrap">'+r.user_id+'</td>'
        + '<td>'+(r.email||'—')+'</td>'
        + '<td>'+(r.phone||'—')+'</td>'
        + '<td class="right">'+fmtCents(bal[r.user_id]||0)+'</td>'
        + '<td>'+(r.ref_code||'—')+'</td>';
      tbody.appendChild(tr);
    });
    window._treeCache = rows;
  }
  $('#treeLoad').addEventListener('click', buildTreeByKey);
  $('#treeExport').addEventListener('click', ()=>{ const arr=(window._treeCache||[]).map(r=>({ level:r.level, user_id:r.user_id })); exportCSV('ref_tree.csv', arr); });

  // ===================== DRAWER (PROFILE) =====================
  $('#dClose').addEventListener('click', ()=>$('#drawer').classList.remove('open'));
  $('#dCopyUID').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText($('#dUserId').value); alert('Скопировано'); }catch(_){ alert('Скопируйте вручную'); } });

  async function openUserDrawer(uid){
    if(!uid) return;
    $('#drawer').classList.add('open'); $('#dTitle').textContent='Профиль: '+uid; $('#dUserId').value=uid;
    const [prof, wallet, wds, rrs] = await Promise.all([
      sb.from('profiles').select('user_id, created_at, email, phone, ref_code').eq('user_id', uid).maybeSingle(),
      sb.from('wallets').select('user_id, balance_cents').eq('user_id', uid).maybeSingle(),
      sb.from('withdrawals').select('created_at, amount_cents, status, txid').eq('user_id', uid).order('created_at', {ascending:false}).limit(20),
      // УБРАЛ amount_usd и reward_usdt — как в loadRewards
      sb.from('v_admin_rewards').select('created_at, level, amount_cents, source_user_id, note, target_user_id').eq('target_user_id', uid).order('created_at', {ascending:false}).limit(300)
    ]);
    $('#dCreated').value = prof?.data?.created_at ? new Date(prof.data.created_at).toLocaleString() : '—';
    $('#dEmail').value = prof?.data?.email || '';
    $('#dPhone').value = prof?.data?.phone || '';
    $('#dBalance').value = ((wallet?.data?.balance_cents||0)/100).toFixed(2);
    $('#dRefCode').value = prof?.data?.ref_code || '';
    $('#dRefLink').value = prof?.data?.ref_code ? buildRefLink(prof.data.ref_code) : '';

    const wtbody = $('#dWTable tbody'); wtbody.innerHTML='';
    (wds?.data||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML='<td class="nowrap">'+new Date(r.created_at).toLocaleString()+'</td><td class="right">'+fmtCents(r.amount_cents||0)+'</td><td>'+String(r.status||'pending')+'</td><td class="nowrap">'+(r.txid?('<code>'+short(r.txid)+'</code>'):'—')+'</td>'; wtbody.appendChild(tr); });

    const rtbody = $('#dRTable tbody'); rtbody.innerHTML='';
    let dL1=0,dL2=0,dL3=0, dAll=0;
    (rrs?.data||[]).forEach(r=>{
      const amt = r.amount_cents || 0;
      dAll += (amt||0);
      if (+r.level===1) dL1+=(amt||0);
      if (+r.level===2) dL2+=(amt||0);
      if (+r.level===3) dL3+=(amt||0);
      const tr=document.createElement('tr');
      tr.innerHTML='<td class="nowrap">'+new Date(r.created_at).toLocaleString()+'</td><td>'+(r.level??'—')+'</td><td class="right">'+fmtCents(amt||0)+'</td><td class="nowrap">'+(r.source_user_id||'—')+'</td>';
      rtbody.appendChild(tr);
    });
    $('#dRwAll').textContent = fmtCents(dAll);
    $('#dRwL1').textContent = fmtCents(dL1);
    $('#dRwL2').textContent = fmtCents(dL2);
    $('#dRwL3').textContent = fmtCents(dL3);

    $('#dCopyRef').onclick = async ()=>{ try{ await navigator.clipboard.writeText($('#dRefLink').value); alert('Скопировано'); }catch(_){ alert('Скопируйте вручную'); } };
    $('#dSaveProfile').onclick = async ()=>{ try{
      const upd=await sb.from('profiles').update({ email:$('#dEmail').value||null, phone:$('#dPhone').value||null, ref_code:$('#dRefCode').value||null }).eq('user_id', uid).select().maybeSingle();
      if(upd.error) throw upd.error; alert('Сохранено'); loadUsers(); }catch(e){ alert(e.message||e); } };

    const deltaRow = document.getElementById('deltaRow');
    if (hasAdjust){ deltaRow.classList.remove('hidden'); } else { deltaRow.classList.add('hidden'); }
    $('#dApplyDelta').onclick = async ()=>{ const delta=Number($('#dDelta').value||'0'); if(!Number.isFinite(delta)||!delta){ alert('Введите число (USDT)'); return; }
      try{ const r=await sb.rpc('admin_adjust_balance', { p_user_id: uid, p_delta_cents: toCents(delta) }); if(r.error) throw r.error; alert('Баланс скорректирован'); openUserDrawer(uid); loadUsers(); }catch(e){ alert(e.message||e); } };
  }

  // ===================== UTILS & INIT =====================
  function buildRefLink(code){ if(!code) return ''; try{ const url = new URL(location.origin + '/register_single.html'); url.searchParams.set('ref', code); return url.toString(); }catch(_){ return 'https://example.com/register_single.html?ref='+encodeURIComponent(code); } }

  function exportCSV(name, rows){
    if(!rows||!rows.length){ alert('Нет данных'); return; }
    const keys = Object.keys(rows[0]);
    const esc = v => '"' + String(v ?? '').replace(/"/g,'""') + '"';
    const csv = [keys.join(',')].concat(rows.map(r=>keys.map(k=>esc(r[k])).join(','))).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }

  (async function init(){
    await refreshAuth();
    await checkAdmin();
    if(!isAdmin) return;
    await detectAdjust();
    // Авто-подзагрузка
    if ($('.tab.active')?.dataset.tab==='withdrawals') loadWithdrawals(true);
    setTimeout(loadUsers,150);
    setTimeout(loadRewards,300);
  })();

})();

  // ===== Deposits =====
  let dRowsCache=[];
  async function loadDeposits(){
    if(!isAdmin) return;
    const tbody = $('#dTable tbody'); if(!tbody) return;
    tbody.innerHTML = '<tr><td colspan="7" class="muted small">Загрузка…</td></tr>';
    const r = await sb.from('v_admin_deposits')
      .select('id, created_at, user_id, user_email, user_phone, amount_cents, currency, network, txid, status, note')
      .order('created_at', {ascending:false}).limit(300);
    if(r.error){ tbody.innerHTML = '<tr><td colspan="7" class="err">'+(r.error.message||'error')+'</td></tr>'; return; }
    dRowsCache = r.data||[];
    const s = ($('#dSearch')?.value||'').toLowerCase().trim();
    let rows = dRowsCache;
    if(s){
      rows = rows.filter(x => (x.user_email||'').toLowerCase().includes(s) || (x.user_phone||'').toLowerCase().includes(s) || (x.txid||'').toLowerCase().includes(s) || (x.note||'').toLowerCase().includes(s) );
    }
    const fmtAmt = v => (v/100).toFixed(2);
    const renderUser = x => (x.user_email||x.user_phone||x.user_id||'—');
    const renderTx = x => x.txid ? ('<a href="https://tronscan.org/#/transaction/'+x.txid+'" target="_blank">'+x.txid.slice(0,10)+'…</a>') : '—';
    tbody.innerHTML = rows.map(x => `
      <tr>
        <td>${new Date(x.created_at).toLocaleString()}</td>
        <td>${renderUser(x)}</td>
        <td>${(x.network||'')+' '+(x.currency||'')}</td>
        <td>${fmtAmt(x.amount_cents)}</td>
        <td>${renderTx(x)}</td>
        <td>${x.status}</td>
        <td>${x.note||''}</td>
      </tr>`).join('');
    $('#dCount').textContent = String(rows.length);
    const sum = rows.reduce((a,x)=>a+(x.amount_cents||0),0);
    $('#dSum').textContent = fmtAmt(sum);
  }
  $('#dRefresh')?.addEventListener('click', loadDeposits);
  $('#dExport')?.addEventListener('click', ()=> exportCSV('deposits.csv', dRowsCache||[]));
  $('#dSearch')?.addEventListener('input', ()=> loadDeposits());
  try{ sb.channel('adm-dep').on('postgres_changes', {event:'*', schema:'public', table:'deposits'}, ()=>{ if(activePage==='deposits'){ loadDeposits(); }}).subscribe(); }catch(_){}
</script>
</body>
</html>
