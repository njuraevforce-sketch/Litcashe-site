<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LC ‚Ä¢ Admin (Core-aligned)</title>
  <link rel="icon" href="data:,">
  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
    (function(){
      try{
        if (!window.supabase) throw new Error('supabase.js not loaded');
        // === —Ç–≤–æ–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–∞–∫ –µ—Å—Ç—å) ===
        window.sb = window.supabase.createClient(
          'https://einpfuegfsilnoiareco.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpbnBmdWVnZnNpbG5vaWFyZWNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjM3NzAsImV4cCI6MjA2OTk5OTc3MH0.6wF-8yaV38LrXH6Ptm3KIO34wRklJKbNCVoqIGNKh_w',
          { auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } }
        );
        console.log('[Admin] Supabase init OK');
      } catch(e){ console.error('[Admin] Supabase init error', e); }
    })();
  </script>
  <style>
    :root{
      --bg:#f7f8fa; --panel:#ffffff; --text:#17223b; --muted:#6b7280; --accent:#2563eb;
      --ok:#10b981; --warn:#eab308; --bad:#ef4444; --line:#e5e7eb; --chip:#f3f4f6;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1280px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{font-weight:800;font-size:18px;letter-spacing:.2px}
    .authbar{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted)}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;transition:.15s}
    .btn:hover{box-shadow:0 1px 0 rgba(0,0,0,.05)}
    .btn.ok{background:#ecfdf5;border-color:#d1fae5}
    .btn.warn{background:#fffbeb;border-color:#fef3c7}
    .btn.bad{background:#fef2f2;border-color:#fee2e2}
    .btn.ghost{background:#fff}
    .btn.small{padding:5px 8px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .tab.active{background:#e8f0ff;border-color:#c7d2fe;color:#1e40af}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    input,select,textarea{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{background:#f9fafb;border-bottom:1px solid var(--line);padding:10px;text-align:left;white-space:nowrap}
    td{border-top:1px solid var(--line);padding:10px;vertical-align:top}
    .right{text-align:right}
    .chip{display:inline-block;background:var(--chip);border:1px solid var(--line);padding:3px 8px;border-radius:999px;font-size:12px}
    .pill{padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
    .pill.paid{background:#ecfdf5;border-color:#d1fae5;color:#065f46}
    .pill.pending{background:#eff6ff;border-color:#dbeafe;color:#1e40af}
    .pill.rejected{background:#fef2f2;border-color:#fee2e2;color:#991b1b}
    .cards{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-bottom:10px}
    .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .card .k{font-size:12px;color:var(--muted)}
    .card .v{font-weight:700;font-size:16px}
    .drawer{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-end;justify-content:flex-end}
    .drawer.open{display:flex}
    .drawer .sheet{width:560px;max-width:92vw;height:100%;overflow:auto;background:#fff;border-left:1px solid var(--line);padding:16px}
    .small{font-size:12px}
    .nowrap{white-space:nowrap}
    h3{margin:6px 0 8px}
    .hidden{display:none !important}
    .limited-only{display:none}
    .limited-admin .limited-only{display:block}
    .limited-admin .super-only{display:none !important}
    @media (max-width:900px){ .cards{grid-template-columns:repeat(2,minmax(0,1fr));} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">LC ‚Ä¢ Admin</div>
    <div class="authbar">
      <span class="muted small">–ê–∫–∫–∞—É–Ω—Ç:</span>
      <span id="authInfo" class="nowrap">‚Äî</span>
      <button class="btn" id="btnLogin">–í–æ–π—Ç–∏</button>
      <button class="btn" id="btnLogout" style="display:none">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <!-- LIMITED ADMIN STATS -->
  <div id="limitedStats" class="limited-only panel">
    <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–æ–∏—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</h3>
    <div class="cards">
      <div class="card"><div class="k">–í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div><div id="lTotalUsers" class="v">‚Äî</div></div>
      <div class="card"><div class="k">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div><div id="lTotalBalance" class="v">‚Äî</div></div>
      <div class="card"><div class="k">L1 –±–∞–ª–∞–Ω—Å</div><div id="lL1Balance" class="v">‚Äî</div></div>
      <div class="card"><div class="k">L2 –±–∞–ª–∞–Ω—Å</div><div id="lL2Balance" class="v">‚Äî</div></div>
    </div>
  </div>

  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="withdrawals">–ó–∞—è–≤–∫–∏</button>
    <button class="tab" data-tab="users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
    <button class="tab" data-tab="refs">–†–µ—Ñ–µ—Ä–∞–ª—ã</button>
    <button class="tab" data-tab="rewards">–ù–∞—á–∏—Å–ª–µ–Ω–∏—è</button>
    <button class="tab" data-tab="deposits">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è</button>
    <button class="tab" data-tab="about">–°–ø—Ä–∞–≤–∫–∞</button>
  </div>

  <!-- WITHDRAWALS -->
  <section class="panel" data-page="withdrawals">
    <div class="cards">
      <div class="card"><div class="k">–í—Å–µ–≥–æ (–æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ)</div><div id="wCount" class="v">‚Äî</div></div>
      <div class="card"><div class="k">–°—É–º–º–∞ –∑–∞—è–≤–æ–∫</div><div id="wSum" class="v">‚Äî</div></div>
      <div class="card"><div class="k">–ö–æ–º–∏—Å—Å–∏–∏</div><div id="wFee" class="v">‚Äî</div></div>
      <div class="card"><div class="k">–ò—Ç–æ–≥–æ –∫ –≤—ã–ø–ª–∞—Ç–µ</div><div id="wTotal" class="v">‚Äî</div></div>
    </div>

    <div class="row">
      <select id="wStatus">
        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
        <option value="pending">–û–∂–∏–¥–∞–Ω–∏–µ</option>
        <option value="paid">–û–ø–ª–∞—á–µ–Ω–æ</option>
        <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
      </select>
      <input id="wSearch" class="grow" placeholder="–ü–æ–∏—Å–∫: id, –∞–¥—Ä–µ—Å, TX, email, —Ç–µ–ª–µ—Ñ–æ–Ω">
      <input id="wFrom" type="date" title="—Å –¥–∞—Ç—ã">
      <input id="wTo" type="date" title="–ø–æ –¥–∞—Ç—É">
      <input id="wAmtMin" type="number" step="0.01" placeholder="–º–∏–Ω USDT" style="width:120px">
      <input id="wAmtMax" type="number" step="0.01" placeholder="–º–∞–∫—Å USDT" style="width:120px">
      <button class="btn" id="wReload">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <button class="btn ghost" id="wExport">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
    </div>

    <div class="table-wrap" style="margin-top:8px">
      <table id="wTable">
        <thead><tr>
          <th>ID</th><th>–°–æ–∑–¥–∞–Ω–æ</th><th>Email</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
          <th class="right">–°—É–º–º–∞</th><th class="right">–ö–æ–º–∏—Å—Å–∏—è</th><th class="right">–ò—Ç–æ–≥–æ</th>
          <th>–°–µ—Ç—å</th><th>–ê–¥—Ä–µ—Å</th><th>–°—Ç–∞—Ç—É—Å</th><th>TX/–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th><th></th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="muted small" id="wDiag">‚Äî</span>
      <span class="grow"></span>
      <button class="btn ghost" id="wPrev">–ù–∞–∑–∞–¥</button>
      <button class="btn ghost" id="wNext">–í–ø–µ—Ä—ë–¥</button>
    </div>
  </section>

  <!-- USERS -->
  <section class="panel" data-page="users" style="display:none">
    <div class="cards">
      <div class="card"><div class="k">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ—Ç—Ñ–∏–ª—å—Ç—Ä.)</div><div id="uCount" class="v">‚Äî</div></div>
      <div class="card"><div class="k">–°—É–º–º–∞ –±–∞–ª–∞–Ω—Å–æ–≤</div><div id="uSumBal" class="v">‚Äî</div></div>
      <div class="card"><div class="k">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–∞–Ω—Å</div><div id="uAvgBal" class="v">‚Äî</div></div>
      <div class="card"><div class="k">–° ref-–∫–æ–¥–æ–º</div><div id="uWithRef" class="v">‚Äî</div></div>
    </div>
    <div class="row">
      <input id="uSearch" class="grow" placeholder="–ü–æ–∏—Å–∫: email, —Ç–µ–ª–µ—Ñ–æ–Ω, user_id, ref_code">
      <input id="uBalMin" type="number" step="0.01" placeholder="–±–∞–ª–∞–Ω—Å ‚â• USDT" style="width:150px">
      <input id="uBalMax" type="number" step="0.01" placeholder="–±–∞–ª–∞–Ω—Å ‚â§ USDT" style="width:150px">
      <button class="btn" id="uReload">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <button class="btn ghost" id="uExport">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
      <span class="muted small" id="uDiag">‚Äî</span>
    </div>
    <div class="table-wrap" style="margin-top:8px">
      <table id="uTable">
        <thead><tr>
          <th>ID</th><th>–°–æ–∑–¥–∞–Ω–æ</th><th>Email</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
          <th class="right">–ë–∞–ª–∞–Ω—Å</th><th>–†–µ—Ñ-–∫–æ–¥</th><th>–†–µ—Ñ-—Å—Å—ã–ª–∫–∞</th><th></th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- REFS -->
  <section class="panel" data-page="refs" style="display:none">
    <!-- LIMITED ADMIN VIEW -->
    <div class="limited-only">
      <h3>üë• –ú–æ–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã (–≤—Å–µ –ø–æ–∫–æ–ª–µ–Ω–∏—è)</h3>
      <div class="table-wrap" style="margin-top:8px">
        <table id="limitedRefsTable">
          <thead><tr>
            <th>–£—Ä–æ–≤–µ–Ω—å</th><th>User ID</th><th>Email</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
            <th class="right">–ë–∞–ª–∞–Ω—Å</th><th>–†–µ—Ñ-–∫–æ–¥</th><th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:12px; justify-content: flex-end;">
        <button class="btn ghost" id="limitedExport">–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
      </div>
    </div>

    <!-- SUPER ADMIN VIEW -->
    <div class="super-only">
      <div class="row">
        <input id="rInviter" class="grow" placeholder="User ID –∏–ª–∏ –†–ï–§-–ö–û–î (–ø–æ–∫–∞–∑–∞—Ç—å L1)">
        <button class="btn" id="rLoadL1">–ü–æ–∫–∞–∑–∞—Ç—å L1</button>
        <button class="btn ghost" id="rExportL1">–≠–∫—Å–ø–æ—Ä—Ç L1</button>
      </div>
      <div class="table-wrap" style="margin-top:8px">
        <table id="rL1Table">
          <thead><tr><th>User ID</th><th>Email</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th class="right">–ë–∞–ª–∞–Ω—Å</th><th>–†–µ—Ñ-–∫–æ–¥</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="row" style="margin-top:12px">
        <input id="treeUser" class="grow" placeholder="User ID –∏–ª–∏ –†–ï–§-–ö–û–î (–¥–µ—Ä–µ–≤–æ 1‚Äì3)">
        <button class="btn" id="treeLoad">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å 1‚Äì3</button>
        <button class="btn ghost" id="treeExport">–≠–∫—Å–ø–æ—Ä—Ç –¥–µ—Ä–µ–≤–∞</button>
      </div>
      <div class="table-wrap" style="margin-top:8px">
        <table id="treeTable">
          <thead><tr><th>–£—Ä–æ–≤–µ–Ω—å</th><th>User ID</th><th>Email</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th class="right">–ë–∞–ª–∞–Ω—Å</th><th>–†–µ—Ñ-–∫–æ–¥</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- REWARDS -->
  <section class="panel" data-page="rewards" style="display:none">
    <div class="cards">
      <div class="card"><div class="k">–ó–∞–ø–∏—Å–µ–π (–æ—Ç—Ñ–∏–ª—å—Ç—Ä.)</div><div id="rwCount" class="v">‚Äî</div></div>
      <div class="card"><div class="k">–°—É–º–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</div><div id="rwSum" class="v">‚Äî</div></div>
      <div class="card"><div class="k">L1 / L2 / L3</div><div id="rwByLvl" class="v">‚Äî</div></div>
      <div class="card"><div class="k">–ü–µ—Ä–∏–æ–¥</div><div id="rwRange" class="v">‚Äî</div></div>
    </div>
    <div class="row">
      <select id="rwLevel">
        <option value="">–£—Ä–æ–≤–µ–Ω—å: –≤—Å–µ</option>
        <option value="0">0</option><option value="1">1</option>
        <option value="2">2</option><option value="3">3</option>
      </select>
      <input id="rwFrom" type="date" title="—Å –¥–∞—Ç—ã">
      <input id="rwTo" type="date" title="–ø–æ –¥–∞—Ç—É">
      <input id="rwSearch" class="grow" placeholder="–ü–æ–∏—Å–∫: target_user, source_user, –∑–∞–º–µ—Ç–∫–∞">
      <button class="btn" id="rwReload">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <button class="btn ghost" id="rwExport">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
      <span class="muted small" id="rwDiag">‚Äî</span>
    </div>
    <div class="table-wrap" style="margin-top:8px">
      <table id="rwTable">
        <thead><tr>
          <th>–î–∞—Ç–∞</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th><th class="right">–°—É–º–º–∞</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- DEPOSITS -->
  <section class="panel" data-page="deposits" style="display:none">
    <div class="cards">
      <div class="card"><div class="k">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–π</div><div id="dCount" class="v">‚Äî</div></div>
      <div class="card"><div class="k">–°—É–º–º–∞</div><div id="dSum" class="v">‚Äî</div></div>
    </div>
    <div class="row">
      <input id="dSearch" class="grow" placeholder="–ü–æ–∏—Å–∫: email, —Ç–µ–ª–µ—Ñ–æ–Ω, TX">
      <button class="btn" id="dRefresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <button class="btn ghost" id="dExport">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
    </div>
    <div class="table-wrap" style="margin-top:8px">
      <table id="dTable">
        <thead><tr>
          <th>–î–∞—Ç–∞</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–°–µ—Ç—å</th><th class="right">–°—É–º–º–∞</th><th>TX</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ABOUT -->
  <section class="panel" data-page="about" style="display:none">
    <h3>–°–ø—Ä–∞–≤–∫–∞</h3>
    <p class="small muted">
      –ò—Å—Ç–æ—á–Ω–∏–∫–∏ (CORE): <code>v_admin_profiles</code>, <code>wallets</code>, <code>v_admin_rewards</code>, (–æ–ø—Ü.) <code>v_admin_rewards_totals</code>. RPC: <code>lc_is_admin</code>, <code>admin_list_users</code>, <code>admin_get_ref_tree</code>, <code>admin_balances_by_user_ids</code>, (–æ–ø—Ü.) <code>admin_update_withdrawal</code>, <code>admin_adjust_balance</code>.<br>
      –ë–∞–ª–∞–Ω—Å –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π: <code>wallets.balance_cents</code>. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –Ω–µ –º–µ–Ω—è–µ—Ç —Å—Ö–µ–º—É —Å–∞–π—Ç–∞.
    </p>
  </section>
</div>

<!-- Drawer -->
<div class="drawer" id="drawer">
  <div class="sheet">
    <div class="row" style="justify-content:space-between">
      <h3 id="dTitle" style="margin:6px 0">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
      <button class="btn" id="dCopyUID">Copy ID</button>
      <button class="btn ghost" id="dClose">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="row">
      <div class="grow">
        <div class="small muted">User ID</div><input id="dUserId" class="grow" readonly>
      </div>
      <div class="grow">
        <div class="small muted">–°–æ–∑–¥–∞–Ω</div><input id="dCreated" class="grow" readonly>
      </div>
    </div>
    <div class="row">
      <div class="grow"><div class="small muted">Email</div><input id="dEmail" class="grow"></div>
      <div class="grow"><div class="small muted">–¢–µ–ª–µ—Ñ–æ–Ω</div><input id="dPhone" class="grow"></div>
    </div>
    <div class="row">
      <div class="grow"><div class="small muted">–ë–∞–ª–∞–Ω—Å (USDT)</div><input id="dBalance" type="number" step="0.01" class="grow" readonly></div>
      <div class="grow"><div class="small muted">–†–µ—Ñ-–∫–æ–¥</div><input id="dRefCode" class="grow"></div>
    </div>
    <div class="row">
      <div class="grow"><div class="small muted">–†–µ—Ñ-—Å—Å—ã–ª–∫–∞</div><input id="dRefLink" class="grow" readonly></div>
      <button class="btn" id="dCopyRef">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <div id="deltaRow" class="row hidden" style="margin-top:6px">
      <div class="grow"><div class="small muted">–ò–∑–º–µ–Ω–µ–Ω–∏–µ (¬±USDT)</div><input id="dDelta" type="number" step="0.01" class="grow" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 15 –∏–ª–∏ -7.5"></div>
      <button class="btn warn" id="dApplyDelta">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <button class="btn ok" id="dSaveProfile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <h3 style="margin-top:12px">–°–≤–æ–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π (–ø–æ –ø—Ä–æ—Ñ–∏–ª—é)</h3>
    <div class="cards" style="margin-top:6px">
      <div class="card"><div class="k">–ò—Ç–æ–≥–æ</div><div id="dRwAll" class="v">‚Äî</div></div>
      <div class="card"><div class="k">L1</div><div id="dRwL1" class="v">‚Äî</div></div>
      <div class="card"><div class="k">L2</div><div id="dRwL2" class="v">‚Äî</div></div>
      <div class="card"><div class="k">L3</div><div id="dRwL3" class="v">‚Äî</div></div>
    </div>

    <h3>–ó–∞—è–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
    <div class="table-wrap">
      <table id="dWTable"><thead><tr><th>–î–∞—Ç–∞</th><th>–°—É–º–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>TX</th></tr></thead><tbody></tbody></table>
    </div>
    <h3>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</h3>
    <div class="table-wrap">
      <table id="dRTable"><thead><tr><th>–î–∞—Ç–∞</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–°—É–º–º–∞</th><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const sb = window.sb;
  if (!sb) { alert('Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'); return; }
  
  const fmtCents = c => ((+c||0)/100).toLocaleString('ru-RU', {minimumFractionDigits:0, maximumFractionDigits:2}) + ' USDT';
  const escapeHtml = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  
  let currentAdmin = { type: 'super', ref_code: null };

  // ===================== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ò –ü–†–ê–í–ê =====================
  async function checkAdminRights() {
    try {
      const { data: { user } } = await sb.auth.getUser();
      if (!user) {
        alert('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
        return false;
      }

      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ RPC —Ñ—É–Ω–∫—Ü–∏—é
      try {
        const { data: adminData, error } = await sb.rpc('get_admin_type');
        if (!error && adminData && adminData.length > 0) {
          currentAdmin = adminData[0];
          return true;
        }
      } catch (e) {}

      // –§–æ–ª–±—ç–∫: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É admins
      const { data: adminRow, error } = await sb.from('admins')
        .select('admin_type, ref_code')
        .eq('user_id', user.id)
        .maybeSingle();

      if (error || !adminRow) {
        alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
        return false;
      }

      currentAdmin = adminRow;
      return true;
      
    } catch (error) {
      console.error('Admin check error:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤');
      return false;
    }
  }

  function setupUIForAdminType() {
    if (currentAdmin.type === 'limited') {
      document.body.classList.add('limited-admin');
      $('#authInfo').textContent = `Limited Admin (${currentAdmin.ref_code})`;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∫–ª–∞–¥–∫—É —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
      $$('#tabs .tab').forEach(tab => {
        if (tab.dataset.tab !== 'refs') {
          tab.style.display = 'none';
        }
      });
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
      $$('#tabs .tab').forEach(tab => tab.classList.remove('active'));
      $('[data-tab="refs"]').classList.add('active');
      $$('[data-page]').forEach(p => p.style.display = 'none');
      $('[data-page="refs"]').style.display = 'block';

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ limited admin
      loadLimitedAdminData();
    } else {
      $('#authInfo').textContent = 'Super Admin';
    }
  }

  // ===================== LIMITED ADMIN DATA =====================
  async function loadLimitedAdminData() {
    if (currentAdmin.type !== 'limited' || !currentAdmin.ref_code) return;
    
    const tbody = $('#limitedRefsTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="7" class="muted small">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ä–µ–≤–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤...</td></tr>';

    try {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ä–µ–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (–≤—Å–µ –ø–æ–∫–æ–ª–µ–Ω–∏—è)
      const { data, error } = await sb.rpc('get_ref_tree_limited', { 
        p_ref_code: currentAdmin.ref_code,
        p_max_level: 100 
      });

      if (error) throw error;

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="muted small">–ù–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</td></tr>';
        updateLimitedStats(0, 0, {}, {});
        return;
      }

      // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      let totalUsers = data.length;
      let totalBalance = 0;
      const balanceByLevel = {};
      const usersByLevel = {};
      
      data.forEach(row => {
        const balance = Number(row.balance_cents || 0);
        totalBalance += balance;
        const level = row.level;
        
        if (!balanceByLevel[level]) balanceByLevel[level] = 0;
        if (!usersByLevel[level]) usersByLevel[level] = 0;
        
        balanceByLevel[level] += balance;
        usersByLevel[level]++;
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      updateLimitedStats(totalUsers, totalBalance, balanceByLevel, usersByLevel);

      // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É
      renderLimitedReferralsTable(data, tbody);
      
    } catch (error) {
      console.error('Error loading limited admin data:', error);
      tbody.innerHTML = '<tr><td colspan="7" class="small" style="color:#b91c1c">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
    }
  }

  function updateLimitedStats(totalUsers, totalBalance, balanceByLevel, usersByLevel) {
    $('#lTotalUsers').textContent = totalUsers;
    $('#lTotalBalance').textContent = fmtCents(totalBalance);
    $('#lL1Balance').textContent = fmtCents(balanceByLevel[1] || 0);
    $('#lL2Balance').textContent = fmtCents(balanceByLevel[2] || 0);
  }

  function renderLimitedReferralsTable(data, tbody) {
    tbody.innerHTML = '';
    
    data.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.level}</td>
        <td class="nowrap"><code>${row.user_id}</code></td>
        <td>${escapeHtml(row.email || '‚Äî')}</td>
        <td>${escapeHtml(row.phone || '‚Äî')}</td>
        <td class="right">${fmtCents(row.balance_cents)}</td>
        <td>${escapeHtml(row.ref_code || '‚Äî')}</td>
        <td class="nowrap">${new Date(row.created_at).toLocaleDateString()}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ===================== –≠–ö–°–ü–û–†–¢ –î–õ–Ø LIMITED ADMIN =====================
  function setupLimitedAdminExport() {
    const exportBtn = $('#limitedExport');
    if (exportBtn) {
      exportBtn.addEventListener('click', async () => {
        try {
          const { data, error } = await sb.rpc('get_ref_tree_limited', { 
            p_ref_code: currentAdmin.ref_code,
            p_max_level: 100 
          });
          
          if (error) throw error;
          exportCSV('my_referrals.csv', data || []);
        } catch (error) {
          alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + (error.message || error));
        }
      });
    }
  }

  // ===================== –£–¢–ò–õ–ò–¢–´ =====================
  function exportCSV(name, rows) {
    if (!rows || !rows.length) { alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'); return; }
    const keys = Object.keys(rows[0]);
    const esc = v => '"' + String(v ?? '').replace(/"/g,'""') + '"';
    const csv = [keys.join(',')].concat(rows.map(r => keys.map(k => esc(r[k])).join(','))).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
  }

  // ===================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====================
  async function init() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    const { data: { session } } = await sb.auth.getSession();
    if (!session) {
      $('#btnLogin').style.display = 'inline-block';
      $('#btnLogout').style.display = 'none';
      return;
    }

    $('#btnLogin').style.display = 'none';
    $('#btnLogout').style.display = 'inline-block';

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞
    const hasAdminRights = await checkAdminRights();
    if (!hasAdminRights) return;

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    setupUIForAdminType();

    // –î–ª—è limited admin –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —ç–∫—Å–ø–æ—Ä—Ç
    if (currentAdmin.type === 'limited') {
      setupLimitedAdminExport();
    }
  }

  // ===================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô =====================
$('#btnLogin').addEventListener('click', function() {
  var email = prompt('Email –¥–ª—è –≤—Ö–æ–¥–∞:');
  if (!email) return;
  
  var password = prompt('–ü–∞—Ä–æ–ª—å:');
  if (!password) {
    alert('–í—Ö–æ–¥ –æ—Ç–º–µ–Ω–µ–Ω');
    return;
  }
  
  sb.auth.signInWithPassword({ 
    email: email, 
    password: password 
  }).then(function(result) {
    if (result.error) {
      alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + result.error.message);
    } else {
      location.reload();
    }
  }).catch(function(error) {
    alert('–û—à–∏–±–∫–∞: ' + error.message);
  });
});

  $('#btnLogout').addEventListener('click', async () => {
    await sb.auth.signOut();
    location.reload();
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∫–ª–∞–¥–æ–∫ - –¥–ª—è limited admin –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
  $$('#tabs .tab').forEach(btn => {
    btn.addEventListener('click', () => {
      if (currentAdmin.type === 'limited') return;
      
      $$('#tabs .tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      $$('[data-page]').forEach(p => {
        p.style.display = (p.getAttribute('data-page') === tab) ? 'block' : 'none';
      });
    });
  });

  // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
  init();
})();
</script>
</body>
</html>
