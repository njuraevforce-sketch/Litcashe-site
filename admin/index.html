<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LC • Admin (Core-aligned)</title>
  <link rel="icon" href="data:,">
  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <style>
    :root{
      --bg:#f7f8fa; --panel:#ffffff; --text:#17223b; --muted:#6b7280; --accent:#2563eb;
      --ok:#10b981; --warn:#eab308; --bad:#ef4444; --line:#e5e7eb; --chip:#f3f4f6;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1280px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{font-weight:800;font-size:18px;letter-spacing:.2px}
    .authbar{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted)}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;transition:.15s}
    .btn:hover{box-shadow:0 1px 0 rgba(0,0,0,.05)}
    .btn.ok{background:#ecfdf5;border-color:#d1fae5}
    .btn.warn{background:#fffbeb;border-color:#fef3c7}
    .btn.bad{background:#fef2f2;border-color:#fee2e2}
    .btn.ghost{background:#fff}
    .btn.small{padding:5px 8px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .tab.active{background:#e8f0ff;border-color:#c7d2fe;color:#1e40af}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    input,select,textarea{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(59,130,246,.15)}
    .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{background:#f9fafb;border-bottom:1px solid var(--line);padding:10px;text-align:left;white-space:nowrap}
    td{border-top:1px solid var(--line);padding:10px;vertical-align:top}
    .right{text-align:right}
    .chip{display:inline-block;background:var(--chip);border:1px solid var(--line);padding:3px 8px;border-radius:999px;font-size:12px}
    .pill{padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
    .pill.paid{background:#ecfdf5;border-color:#d1fae5;color:#065f46}
    .pill.pending{background:#eff6ff;border-color:#dbeafe;color:#1e40af}
    .pill.rejected{background:#fef2f2;border-color:#fee2e2;color:#991b1b}
    .cards{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-bottom:10px}
    .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .card .k{font-size:12px;color:var(--muted)}
    .card .v{font-weight:700;font-size:16px}
    .drawer{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-end;justify-content:flex-end}
    .drawer.open{display:flex}
    .drawer .sheet{width:560px;max-width:92vw;height:100%;overflow:auto;background:#fff;border-left:1px solid var(--line);padding:16px}
    .small{font-size:12px}
    .nowrap{white-space:nowrap}
    h3{margin:6px 0 8px}
    .hidden{display:none !important}
    @media (max-width:900px){ .cards{grid-template-columns:repeat(2,minmax(0,1fr));} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">LC • Admin</div>
    <div class="authbar">
      <span class="muted small">Аккаунт:</span>
      <span id="authInfo" class="nowrap">—</span>
      <button class="btn" id="btnLogin">Войти</button>
      <button class="btn" id="btnLogout" style="display:none">Выйти</button>
    </div>
  </div>

  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="withdrawals">Заявки</button>
    <button class="tab" data-tab="users">Пользователи</button>
    <button class="tab" data-tab="refs">Рефералы</button>
    <button class="tab" data-tab="rewards">Начисления</button>
    <button class="tab" data-tab="deposits">Пополнения</button>
    <button class="tab" data-tab="about">Справка</button>
  </div>

  <!-- WITHDRAWALS -->
  <section class="panel" data-page="withdrawals">
    <div class="cards">
      <div class="card"><div class="k">Всего (отфильтровано)</div><div id="wCount" class="v">—</div></div>
      <div class="card"><div class="k">Сумма заявок</div><div id="wSum" class="v">—</div></div>
      <div class="card"><div class="k">Комиссии</div><div id="wFee" class="v">—</div></div>
      <div class="card"><div class="k">Итого к выплате</div><div id="wTotal" class="v">—</div></div>
    </div>

    <div class="row">
      <select id="wStatus">
        <option value="">Все статусы</option>
        <option value="pending">Ожидание</option>
        <option value="paid">Оплачено</option>
        <option value="rejected">Отклонено</option>
      </select>
      <input id="wSearch" class="grow" placeholder="Поиск: id, адрес, TX, email, телефон">
      <input id="wFrom" type="date" title="с даты">
      <input id="wTo" type="date" title="по дату">
      <input id="wAmtMin" type="number" step="0.01" placeholder="мин USDT" style="width:120px">
      <input id="wAmtMax" type="number" step="0.01" placeholder="макс USDT" style="width:120px">
      <button class="btn" id="wReload">Обновить</button>
      <button class="btn ghost" id="wExport">Экспорт CSV</button>
    </div>

    <div class="table-wrap" style="margin-top:8px">
      <table id="wTable">
        <thead><tr>
          <th>User ID</th><th>Создано</th><th>Email</th><th>Телефон</th>
          <th class="right">Сумма</th><th class="right">Комиссия</th><th class="right">Итого</th>
          <th>Сеть</th><th>Адрес</th><th>Статус</th><th>TX/Примечание</th><th></th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="muted small" id="wDiag">—</span>
      <span class="grow"></span>
      <button class="btn ghost" id="wPrev">Назад</button>
      <button class="btn ghost" id="wNext">Вперёд</button>
    </div>
  </section>

  <!-- USERS -->
  <section class="panel" data-page="users" style="display:none">
    <div class="cards">
      <div class="card"><div class="k">Пользователей (отфильтр.)</div><div id="uCount" class="v">—</div></div>
      <div class="card"><div class="k">Сумма балансов</div><div id="uSumBal" class="v">—</div></div>
      <div class="card"><div class="k">Средний баланс</div><div id="uAvgBal" class="v">—</div></div>
      <div class="card"><div class="k">С ref-кодом</div><div id="uWithRef" class="v">—</div></div>
    </div>
    <div class="row">
      <input id="uSearch" class="grow" placeholder="Поиск: email, телефон, user_id, ref_code">
      <input id="uBalMin" type="number" step="0.01" placeholder="баланс ≥ USDT" style="width:150px">
      <input id="uBalMax" type="number" step="0.01" placeholder="баланс ≤ USDT" style="width:150px">
      <button class="btn" id="uReload">Обновить</button>
      <button class="btn ghost" id="uExport">Экспорт CSV</button>
      <span class="muted small" id="uDiag">—</span>
    </div>
    <div class="table-wrap" style="margin-top:8px">
      <table id="uTable">
        <thead><tr>
          <th>ID</th><th>Создано</th><th>Email</th><th>Телефон</th>
          <th class="right">Баланс</th><th>Реф-код</th><th>Реф-ссылка</th><th></th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- REFS -->
  <section class="panel" data-page="refs" style="display:none">
    <div class="row">
      <input id="rInviter" class="grow" placeholder="User ID или РЕФ-КОД (показать L1)">
      <button class="btn" id="rLoadL1">Показать L1</button>
      <button class="btn ghost" id="rExportL1">Экспорт L1</button>
    </div>
    <div class="table-wrap" style="margin-top:8px">
      <table id="rL1Table">
        <thead><tr><th>User ID</th><th>Email</th><th>Телефон</th><th class="right">Баланс</th><th>Реф-код</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="row" style="margin-top:12px">
      <input id="treeUser" class="grow" placeholder="User ID или РЕФ-КОД (дерево 1–10)">
      <button class="btn" id="treeLoad">Построить 1–10</button>
      <button class="btn ghost" id="treeExport">Экспорт дерева</button>
    </div>
    <div class="table-wrap" style="margin-top:8px">
      <table id="treeTable">
        <thead><tr><th>Уровень</th><th>User ID</th><th>Email</th><th>Телефон</th><th class="right">Баланс</th><th>Реф-код</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- REWARDS -->
  <section class="panel" data-page="rewards" style="display:none">
    <div class="cards">
      <div class="card"><div class="k">Записей (отфильтр.)</div><div id="rwCount" class="v">—</div></div>
      <div class="card"><div class="k">Сумма начислений</div><div id="rwSum" class="v">—</div></div>
      <div class="card"><div class="k">L1 / L2 / L3</div><div id="rwByLvl" class="v">—</div></div>
      <div class="card"><div class="k">Период</div><div id="rwRange" class="v">—</div></div>
    </div>
    <div class="row">
      <select id="rwLevel">
        <option value="">Уровень: все</option>
        <option value="0">0</option><option value="1">1</option>
        <option value="2">2</option><option value="3">3</option>
      </select>
      <input id="rwFrom" type="date" title="с даты">
      <input id="rwTo" type="date" title="по дату">
      <input id="rwSearch" class="grow" placeholder="Поиск: target_user, source_user, заметка">
      <button class="btn" id="rwReload">Обновить</button>
      <button class="btn ghost" id="rwExport">Экспорт CSV</button>
      <span class="muted small" id="rwDiag">—</span>
    </div>
    <div class="table-wrap" style="margin-top:8px">
      <table id="rwTable">
        <thead><tr>
          <th>Дата</th><th>Уровень</th><th>Получатель</th><th>Источник</th><th class="right">Сумма</th><th>Комментарий</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- DEPOSITS -->
  <section class="panel" data-page="deposits" style="display:none">
    <div class="cards">
      <div class="card"><div class="k">Записей (огранич.)</div><div id="dCount" class="v">—</div></div>
      <div class="card"><div class="k">Сумма (огранич.)</div><div id="dSum" class="v">—</div></div>
      <div class="card"><div class="k">Статус</div><div id="dStatus" class="v">—</div></div>
      <div class="card"><div class="k">Последнее обновление</div><div id="dUpdated" class="v">—</div></div>
    </div>

    <div class="row">
      <input id="dSearch" class="grow" placeholder="Поиск: email, телефон, txid, note">
      <button class="btn" id="dRefresh">Обновить</button>
      <button class="btn ghost" id="dExport">Экспорт CSV</button>
    </div>

    <div class="table-wrap" style="margin-top:8px">
      <table id="dTable">
        <thead><tr>
          <th>Дата</th><th>User</th><th>Сеть / Валюта</th><th class="right">Сумма</th><th>TX</th><th>Статус</th><th>Примечание</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ABOUT -->
  <section class="panel" data-page="about" style="display:none">
    <h3>Справка</h3>
    <p class="small muted">
      Источники (CORE): <code>v_admin_profiles</code>, <code>wallets</code>, <code>v_admin_rewards</code>, (опц.) <code>v_admin_rewards_totals</code>.<br>
      RPC: избегаем RPC, которые требуют server-side settings. Используем прямые запросы к <code>user_referrals</code>, <code>profiles</code>, <code>wallets</code>.<br>
      Баланс канонический: <code>wallets.balance_cents</code>. Админ-панель не меняет схему сайта.
    </p>
  </section>
</div>

<!-- Drawer -->
<div class="drawer" id="drawer">
  <div class="sheet">
    <div class="row" style="justify-content:space-between">
      <h3 id="dTitle" style="margin:6px 0">Профиль пользователя</h3>
      <button class="btn" id="dCopyUID">Copy ID</button>
      <button class="btn ghost" id="dClose">Закрыть</button>
    </div>
    <div class="row">
      <div class="grow">
        <div class="small muted">User ID</div><input id="dUserId" class="grow" readonly>
      </div>
      <div class="grow">
        <div class="small muted">Создан</div><input id="dCreated" class="grow" readonly>
      </div>
    </div>
    <div class="row">
      <div class="grow"><div class="small muted">Email</div><input id="dEmail" class="grow"></div>
      <div class="grow"><div class="small muted">Телефон</div><input id="dPhone" class="grow"></div>
    </div>
    <div class="row">
      <div class="grow"><div class="small muted">Баланс (USDT)</div><input id="dBalance" type="number" step="0.01" class="grow" readonly></div>
      <div class="grow"><div class="small muted">Реф-код</div><input id="dRefCode" class="grow"></div>
    </div>
    <div class="row">
      <div class="grow"><div class="small muted">Реф-ссылка</div><input id="dRefLink" class="grow" readonly></div>
      <button class="btn" id="dCopyRef">Копировать</button>
    </div>

    <div id="deltaRow" class="row hidden" style="margin-top:6px">
      <div class="grow"><div class="small muted">Изменение (±USDT)</div><input id="dDelta" type="number" step="0.01" class="grow" placeholder="например, 15 или -7.5"></div>
      <button class="btn warn" id="dApplyDelta">Применить</button>
      <button class="btn ok" id="dSaveProfile">Сохранить</button>
    </div>

    <h3 style="margin-top:12px">Свод начислений (по профилю)</h3>
    <div class="cards" style="margin-top:6px">
      <div class="card"><div class="k">Итого</div><div id="dRwAll" class="v">—</div></div>
      <div class="card"><div class="k">L1</div><div id="dRwL1" class="v">—</div></div>
      <div class="card"><div class="k">L2</div><div id="dRwL2" class="v">—</div></div>
      <div class="card"><div class="k">L3</div><div id="dRwL3" class="v">—</div></div>
    </div>

    <h3>Заявки пользователя</h3>
    <div class="table-wrap">
      <table id="dWTable"><thead><tr><th>Дата</th><th>Сумма</th><th>Статус</th><th>TX</th></tr></thead><tbody></tbody></table>
    </div>
    <h3>Реферальные начисления</h3>
    <div class="table-wrap">
      <table id="dRTable"><thead><tr><th>Дата</th><th>Уровень</th><th>Сумма</th><th>Источник</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script>
(function(){
  // init supabase client (kept as-provided)
  try{
    if (!window.supabase) throw new Error('supabase.js not loaded');
    window.sb = window.supabase.createClient(
      'https://einpfuegfsilnoiareco.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpbnBmdWVnZnNpbG5vaWFyZWNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0MjM3NzAsImV4cCI6MjA2OTk5OTc3MH0.6wF-8yaV38LrXH6Ptm3KIO34wRklJKbNCVoqIGNKh_w',
      { auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } }
    );
    console.log('[Admin] Supabase init OK');
  } catch(e){ console.error('[Admin] Supabase init error', e); alert('Supabase не инициализирован'); }

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const sb = window.sb;
  const fmtCents = c => ((+c||0)/100).toLocaleString('ru-RU', {minimumFractionDigits:0, maximumFractionDigits:2}) + ' USDT';
  const short = s => (s ? String(s).slice(0,6)+'…'+String(s).slice(-4) : '');
  const toCents = v => Math.round((Number(v)||0) * 100);
  const qlike = v => v? '%' + String(v).toLowerCase().trim() + '%' : null;

  // Utilities
  function isUUID(s){ return typeof s === 'string' && /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/.test(s); }
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function downloadCSV(name, rows){
    if(!rows || !rows.length){ alert('Нет данных'); return; }
    const keys = Object.keys(rows[0]);
    const esc = v => '"' + String(v ?? '').replace(/"/g,'""') + '"';
    const csv = [keys.join(',')].concat(rows.map(r=>keys.map(k=>esc(r[k])).join(','))).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }

  let sessionUser = null, isAdmin=false, hasAdjust=false;
  let activePage = 'withdrawals';

  // Auth & admin check (NO lc_is_admin RPC usage)
  async function refreshAuth(){
    try{
      const { data: { session } } = await sb.auth.getSession();
      sessionUser = session?.user || null;
      $('#authInfo').textContent = sessionUser ? (sessionUser.email || sessionUser.id) : 'не авторизованы';
      $('#btnLogin').style.display = sessionUser ? 'none':'inline-block';
      $('#btnLogout').style.display = sessionUser ? 'inline-block':'none';
    }catch(e){ console.warn(e); }
  }
  $('#btnLogin').addEventListener('click', async ()=>{
    try{
      const email = prompt('Email для входа:'); if(!email) return;
      const pwd = prompt('Пароль (пусто — magic-link):') || '';
      if(pwd){
        const { error } = await sb.auth.signInWithPassword({ email, password: pwd });
        if(error){ alert('Ошибка: '+(error.message||error)); return; }
        location.reload();
      } else {
        const { error } = await sb.auth.signInWithOtp({ email, options: { emailRedirectTo: location.href } });
        if(error){ alert('Ошибка отправки ссылки: '+(error.message||error)); return; }
        alert('Ссылка для входа отправлена на email.');
      }
    }catch(e){ alert(String(e)); }
  });
  $('#btnLogout').addEventListener('click', async ()=>{ await sb.auth.signOut(); location.reload(); });

  async function checkAdmin(){
    isAdmin = false;
    try{
      const { data: { user } } = await sb.auth.getUser();
      if (user) {
        // rely on admins table presence; avoids server-side current_setting
        const q = await sb.from('admins').select('user_id, role').eq('user_id', user.id).maybeSingle();
        if (!q.error && q.data?.user_id) {
          isAdmin = true;
        }
      }
    }catch(e){
      console.warn('checkAdmin error', e);
    }
    if (!isAdmin) {
      // disable tabs for non-admins
      $$('#tabs .tab').forEach(b=>b.disabled=true);
      // but allow limited admin to use "refs" only if we detect limited id via sessionUser (optionally)
    }
  }

  async function detectAdjust(){
    // remove RPC that might call server-side current_setting
    hasAdjust = false;
    try{
      // attempt to detect if RPC exists safely
      const r = await sb.rpc('admin_adjust_balance', { p_user_id: '00000000-0000-0000-0000-000000000000', p_delta_cents: 0 });
      if (!r?.error) hasAdjust = true;
    }catch(_){ hasAdjust=false; }
  }

  // Tabs
  $$('#tabs .tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('#tabs .tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      activePage = tab;
      $$('[data-page]').forEach(p => p.style.display = (p.getAttribute('data-page') === tab) ? 'block' : 'none');
      // Auto-load on tab open
      if (tab === 'withdrawals') loadWithdrawals(true);
      if (tab === 'users') loadUsers();
      if (tab === 'rewards') loadRewards();
      if (tab === 'deposits') loadDeposits();
    });
  });

  // ------------------ WITHDRAWALS ------------------
  let wPage = 0, wLimit = 25, wRowsCache = [];

  async function loadWithdrawals(reset){
    if (!isAdmin) return;
    if (reset) wPage = 0;
    const tbody = $('#wTable tbody');
    tbody.innerHTML = '<tr><td colspan="12" class="muted small">Загрузка…</td></tr>';
    const status = $('#wStatus')?.value || null;
    const s = $('#wSearch')?.value?.trim() || null;
    const from = $('#wFrom')?.value ? new Date($('#wFrom').value) : null;
    const to = $('#wTo')?.value ? new Date($('#wTo').value) : null;
    const min = $('#wAmtMin')?.value ? toCents($('#wAmtMin').value) : null;
    const max = $('#wAmtMax')?.value ? toCents($('#wAmtMax').value) : null;

    const params = {
      p_status: status || null,
      p_search: s || null,
      p_from: from ? from.toISOString() : null,
      p_to: to ? to.toISOString() : null,
      p_min: min,
      p_max: max,
      p_offset: wPage * wLimit,
      p_limit: wLimit
    };
    try {
      const r = await sb.rpc('admin_list_withdrawals', params);
      if (r?.error) { tbody.innerHTML = '<tr><td colspan="12" class="small" style="color:#b91c1c">'+(r.error.message||JSON.stringify(r.error))+'</td></tr>'; return; }
      const rows = Array.isArray(r.data)? r.data : (r.data? [r.data] : []);
      wRowsCache = rows;
      // Add resolved id if possible
      for (let i=0;i<rows.length;i++){
        const row = rows[i];
        row._wid = (row.withdrawal_id || row.withdraw_id || row.wid || row.w_id || row.id) || null;
      }
      // Load profiles for email/phone
      const userIds = Array.from(new Set(rows.map(r=>r.user_id).filter(Boolean)));
      const emailByUser = {}, phoneByUser = {};
      if (userIds.length){
        try{
          const prof = await sb.from('profiles').select('user_id,email,phone').in('user_id', userIds);
          if (!prof.error && Array.isArray(prof.data)) prof.data.forEach(p=>{ emailByUser[p.user_id]=p.email; phoneByUser[p.user_id]=p.phone; });
        }catch(_) {}
      }

      if (!rows.length){
        tbody.innerHTML = '<tr><td colspan="12" class="muted small">Нет записей.</td></tr>';
        $('#wCount').textContent = '0'; $('#wSum').textContent = '—'; $('#wFee').textContent='—'; $('#wTotal').textContent='—';
        return;
      }
      tbody.innerHTML = '';
      let sumAmt=0, sumFee=0;
      for (const r of rows){
        const tr = document.createElement('tr');
        const amt = Number(r.amount_cents || 0);
        const fee = Number(r.fee_cents || 0);
        sumAmt += amt; sumFee += fee;
        const userId = r.user_id || '';
        const email = r.user_email || emailByUser[userId] || '—';
        const phone = r.user_phone || phoneByUser[userId] || '—';
        const withdrawalId = r._wid || '';
        const statusTxt = r.status || 'pending';
        tr.innerHTML =
          '<td class="nowrap">'+(userId?'<code>'+escapeHtml(userId)+'</code>':'—')+'</td>' +
          '<td class="nowrap">'+(r.created_at? new Date(r.created_at).toLocaleString() : '—')+'</td>' +
          '<td>' + escapeHtml(email) + '</td>' +
          '<td>' + escapeHtml(phone) + '</td>' +
          '<td class="right">'+fmtCents(amt)+'</td>' +
          '<td class="right">'+fmtCents(fee)+'</td>' +
          '<td class="right">'+fmtCents(amt+fee)+'</td>' +
          '<td>' + (r.network? escapeHtml(r.network) + (r.currency?(' / '+escapeHtml(r.currency)): '') : '—') + '</td>' +
          '<td>' + (r.address? escapeHtml(r.address) : (r.txid? '<code>'+escapeHtml(short(r.txid))+'</code>' : (r.note? '<div class="small muted">'+escapeHtml(r.note)+'</div>':'—'))) + '</td>' +
          '<td>' + escapeHtml(statusTxt) + '</td>' +
          '<td>' + (r.txid? '<code>'+escapeHtml(short(r.txid))+'</code>' : (r.note? '<div class="small muted">'+escapeHtml(r.note)+'</div>' : '—')) + '</td>' +
          '<td class="nowrap small">' +
            '<button class="btn ok small js-withdraw-action" data-act="pay" data-wid="'+escapeHtml(withdrawalId)+'">Оплатить</button> ' +
            '<button class="btn bad small js-withdraw-action" data-act="reject" data-wid="'+escapeHtml(withdrawalId)+'">Отклонить</button> ' +
            '<button class="btn ghost small js-view-user" data-user="'+escapeHtml(userId)+'">Профиль</button>' +
          '</td>';
        tbody.appendChild(tr);
      }
      $('#wCount').textContent = String(rows.length);
      $('#wSum').textContent = fmtCents(sumAmt);
      $('#wFee').textContent = fmtCents(sumFee);
      $('#wTotal').textContent = fmtCents(sumAmt+sumFee);
      $('#wDiag').textContent = 'Страница: ' + (wPage+1);
    } catch (err){
      tbody.innerHTML = '<tr><td colspan="12" class="small" style="color:#b91c1c">'+(err?.message||String(err))+'</td></tr>';
    }
  }

  // Withdraw actions (delegated) - only for true admins
  document.addEventListener('click', async function(e){
    const btn = e.target.closest && e.target.closest('.js-withdraw-action');
    if (!btn) return;
    e.preventDefault();
    if (!isAdmin) { alert('Требуется права администратора'); return; }
    const act = btn.dataset.act;
    const rawWid = btn.dataset.wid;
    btn.disabled = true;

    async function rpcPay(id, tx){
      try { return await sb.rpc('admin_pay_withdrawal_rpc', { p_id: id, p_txid: tx }); }
      catch(e){ return { error: { message: e?.message || String(e) } }; }
    }
    async function rpcReject(id){
      try { return await sb.rpc('admin_reject_withdrawal_rpc', { p_id: id }); }
      catch(e){ return { error: { message: e?.message || String(e) } }; }
    }

    // try direct, otherwise attempt to resolve by cache fields
    try {
      if (act === 'pay'){
        const tx = prompt('Введите TXID (если есть):','') || null;
        let res = await rpcPay(rawWid, tx);
        if (res?.error && /withdrawal not found/i.test(String(res.error.message || res.error || ''))){
          // try resolving from cache
          let candidate = wRowsCache.find(x => [x.withdrawal_id, x.withdraw_id, x.wid, x.w_id, x.id].some(c=>String(c) === String(rawWid)));
          if (!candidate) candidate = wRowsCache.find(x => x.user_id && String(x.user_id) === String(rawWid));
          let realId = null;
          if (candidate) {
            // by user_id + created_at
            try {
              if (candidate.user_id && candidate.created_at){
                const q = await sb.from('withdrawals').select('id').eq('user_id', candidate.user_id).eq('created_at', candidate.created_at).maybeSingle();
                if (!q.error && q.data?.id) realId = q.data.id;
              }
              if (!realId && candidate.user_id && candidate.amount_cents != null){
                const q2 = await sb.from('withdrawals').select('id').eq('user_id', candidate.user_id).eq('amount_cents', candidate.amount_cents).order('created_at', {ascending:false}).limit(1);
                if (!q2.error && q2.data?.length) realId = q2.data[0].id;
              }
            }catch(_){}
          }
          if (!realId){
            alert('Не удалось автоматически найти запись заявки. Откройте DevTools → Network → admin_list_withdrawals и скопируйте поля user_id, created_at и amount_cents для проблемной строки, затем вставьте их в панель админа или сюда для диагностики.');
            return;
          }
          res = await rpcPay(realId, tx);
        }
        if (res?.error){ alert('Ошибка: ' + (res.error.message || JSON.stringify(res.error))); }
        else { alert('Оплачено'); loadWithdrawals(); }
      } else if (act === 'reject'){
        if (!confirm('Отклонить заявку? Баланс вернётся пользователю.')) return;
        let res = await rpcReject(rawWid);
        if (res?.error && /withdrawal not found/i.test(String(res.error.message || res.error || ''))){
          let candidate = wRowsCache.find(x => [x.withdrawal_id, x.withdraw_id, x.wid, x.w_id, x.id].some(c=>String(c) === String(rawWid)));
          if (!candidate) candidate = wRowsCache.find(x => x.user_id && String(x.user_id) === String(rawWid));
          let realId = null;
          if (candidate) {
            try {
              if (candidate.user_id && candidate.created_at){
                const q = await sb.from('withdrawals').select('id').eq('user_id', candidate.user_id).eq('created_at', candidate.created_at).maybeSingle();
                if (!q.error && q.data?.id) realId = q.data.id;
              }
              if (!realId && candidate.user_id && candidate.amount_cents != null){
                const q2 = await sb.from('withdrawals').select('id').eq('user_id', candidate.user_id).eq('amount_cents', candidate.amount_cents).order('created_at', {ascending:false}).limit(1);
                if (!q2.error && q2.data?.length) realId = q2.data[0].id;
              }
            }catch(_){}
          }
          if (!realId){
            alert('Не удалось автоматически найти запись заявки. Откройте DevTools → Network → admin_list_withdrawals и скопируйте поля user_id, created_at и amount_cents для проблемной строки, затем вставьте их в панель админа или сюда для диагностики.');
            return;
          }
          res = await rpcReject(realId);
        }
        if (res?.error){ alert('Ошибка: ' + (res.error.message || JSON.stringify(res.error))); }
        else { alert('Отклонено'); loadWithdrawals(); }
      }
    } catch (err){
      console.error(err); alert('Ошибка сети/сервера: ' + (err?.message || String(err)));
    } finally { btn.disabled = false; }
  });

  // Prev/Next pagination
  $('#wPrev').addEventListener('click', ()=>{
    if (wPage > 0) { wPage--; loadWithdrawals(); }
  });
  $('#wNext').addEventListener('click', ()=>{
    wPage++; loadWithdrawals();
  });

  $('#wReload').addEventListener('click', ()=>loadWithdrawals(true));
  $('#wExport').addEventListener('click', ()=> downloadCSV('withdrawals.csv', wRowsCache.map(r=>({
    user_id: r.user_id, created_at: r.created_at, amount_cents: r.amount_cents, fee_cents: r.fee_cents, status: r.status, txid: r.txid, note: r.note
  }))));

  // ------------------ USERS ------------------
  let uRowsCache = [];
  async function loadUsers(){
    if (!isAdmin) return;
    const tbody = $('#uTable tbody');
    tbody.innerHTML = '<tr><td colspan="8" class="muted small">Загрузка…</td></tr>';
    const s = $('#uSearch')?.value?.trim() || '';
    const balMin = $('#uBalMin')?.value ? toCents($('#uBalMin').value) : null;
    const balMax = $('#uBalMax')?.value ? toCents($('#uBalMax').value) : null;
    let rows = null;
    try {
      const r = await sb.rpc('admin_list_users', { p_search: s || null });
      if (!r.error) {
        const list = Array.isArray(r.data)? r.data : (r.data? [r.data] : []);
        rows = list.map(x=>({
          user_id: x.user_id, created_at: x.activated_at || x.created_at,
          email: x.email, phone: x.phone, ref_code: x.ref_code,
          balance_cents: x.balance_cents ?? 0
        }));
      }
    } catch(_) {}
    if (!rows){
      let q = sb.from('v_admin_profiles').select('user_id, email, phone, ref_code, created_at').order('created_at', {ascending:false}).limit(1000);
      if (s){ const like = qlike(s); q = q.or('user_id.ilike.'+like+',email.ilike.'+like+',phone.ilike.'+like+',ref_code.ilike.'+like); }
      const r = await q;
      if (r.error){ tbody.innerHTML = '<tr><td colspan="8" class="small" style="color:#b91c1c">'+(r.error.message||r.error)+'</td></tr>'; return; }
      const ids = (r.data||[]).map(p=>p.user_id);
      let balances = {};
      if (ids.length){
        const w = await sb.from('wallets').select('user_id,balance_cents').in('user_id', ids);
        (w.data||[]).forEach(x=>balances[x.user_id] = x.balance_cents || 0);
      }
      rows = (r.data||[]).map(p=>({ user_id: p.user_id, created_at: p.created_at, email: p.email, phone: p.phone, ref_code: p.ref_code, balance_cents: balances[p.user_id]||0 }));
    }
    // client-side balance filter
    if (balMin != null || balMax != null){
      rows = (rows||[]).filter(r => (balMin==null || r.balance_cents>=balMin) && (balMax==null || r.balance_cents<=balMax));
    }
    uRowsCache = rows || [];
    const sumBal = uRowsCache.reduce((a,b)=>a+(+b.balance_cents||0),0);
    $('#uCount').textContent = uRowsCache.length;
    $('#uSumBal').textContent = fmtCents(sumBal);
    $('#uAvgBal').textContent = uRowsCache.length? fmtCents(Math.round(sumBal/uRowsCache.length)) : '—';
    $('#uWithRef').textContent = uRowsCache.filter(r=>!!r.ref_code).length;
    $('#uDiag').textContent = uRowsCache.length + ' пользователей';
    if (!uRowsCache.length){ tbody.innerHTML = '<tr><td colspan="8" class="muted small">Пусто</td></tr>'; return; }
    tbody.innerHTML = '';
    for (const r of uRowsCache){
      const link = buildRefLink(r.ref_code);
      const tr = document.createElement('tr');
      tr.innerHTML = '<td class="nowrap">'+escapeHtml(r.user_id)+'</td>'
        + '<td class="nowrap">'+(r.created_at? new Date(r.created_at).toLocaleString():'—')+'</td>'
        + '<td>'+(r.email?escapeHtml(r.email):'—')+'</td>'
        + '<td>'+(r.phone?escapeHtml(r.phone):'—')+'</td>'
        + '<td class="right">'+fmtCents(r.balance_cents||0)+'</td>'
        + '<td>'+(r.ref_code?escapeHtml(r.ref_code):'—')+'</td>'
        + '<td class="nowrap">'+(link?('<code>'+escapeHtml(link)+'</code>'):'—')+'</td>'
        + '<td class="nowrap"><button class="btn ghost small" data-open="'+escapeHtml(r.user_id)+'">Открыть</button></td>';
      tbody.appendChild(tr);
    }
  }
  $('#uReload').addEventListener('click', loadUsers);
  $('#uExport').addEventListener('click', ()=> downloadCSV('users.csv', uRowsCache.map(r=>({ user_id:r.user_id, created_at:r.created_at, email:r.email, phone:r.phone, balance_cents:r.balance_cents, ref_code:r.ref_code })) ));
  $('#uTable').addEventListener('click', e=>{ const btn = e.target.closest('button[data-open]'); if (!btn) return; openUserDrawer(btn.dataset.open); });

  // ------------------ REFS ------------------
  // client-side BFS tree using user_referrals to avoid server RPCs that may use app.current_admin_id
  async function getReferralsTree(rootUserId, maxDepth = 10) {
    if (!rootUserId) return [];
    const collected = new Set();
    let current = [rootUserId];
    for (let depth = 1; depth <= maxDepth; depth++){
      // fetch children where referrer_user_id in current
      const q = await sb.from('user_referrals').select('user_id, referrer_user_id').in('referrer_user_id', current);
      if (q.error || !q.data || !q.data.length) break;
      const next = [];
      for (const r of q.data){
        if (!collected.has(r.user_id) && r.user_id !== rootUserId){
          collected.add(r.user_id);
          next.push(r.user_id);
        }
      }
      if (!next.length) break;
      current = next;
    }
    // return array of user_ids (all descendants)
    return Array.from(collected);
  }

  async function loadL1ByKey(key){
    const tbody = $('#rL1Table tbody');
    key = (key||'').trim();
    tbody.innerHTML = '<tr><td colspan="5" class="muted small">Загрузка…</td></tr>';
    if (!key) { tbody.innerHTML = '<tr><td colspan="5" class="muted small">Укажите User ID или реф-код</td></tr>'; return; }

    // resolve key to user_id if user entered ref_code
    let rootId = key;
    if (!isUUID(key)){
      try{
        const p = await sb.from('profiles').select('user_id').eq('ref_code', key).maybeSingle();
        if (p?.data?.user_id) rootId = p.data.user_id;
      }catch(e){ console.warn(e); }
    }

    // Try get direct L1 from user_referrals (referrer_user_id = rootId)
    try{
      const v1 = await sb.from('user_referrals').select('user_id').eq('referrer_user_id', rootId).limit(2000);
      if (v1.error) throw v1.error;
      if (!v1.data || !v1.data.length){
        tbody.innerHTML = '<tr><td colspan="5" class="muted small">Нет данных</td></tr>';
        window._l1Cache = [];
        return;
      }
      const ids = v1.data.map(x=>x.user_id);
      // fetch profiles and wallets for these ids
      const prof = await sb.from('profiles').select('user_id,email,phone,ref_code').in('user_id', ids);
      const w = await sb.from('wallets').select('user_id,balance_cents').in('user_id', ids);
      const profilesById = {}; (prof.data||[]).forEach(p=>profilesById[p.user_id] = p);
      const balances = {}; (w.data||[]).forEach(x=>balances[x.user_id] = x.balance_cents||0);
      tbody.innerHTML = '';
      const rows = v1.data.map(x=>{
        const p = profilesById[x.user_id] || {};
        return { user_id: x.user_id, email: p.email||'', phone: p.phone||'', balance_cents: balances[x.user_id]||0, ref_code: p.ref_code||'' };
      });
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = '<td class="nowrap">'+escapeHtml(r.user_id)+'</td>'
          + '<td>'+(r.email?escapeHtml(r.email):'—')+'</td>'
          + '<td>'+(r.phone?escapeHtml(r.phone):'—')+'</td>'
          + '<td class="right">'+fmtCents(r.balance_cents||0)+'</td>'
          + '<td>'+(r.ref_code?escapeHtml(r.ref_code):'—')+'</td>';
        tbody.appendChild(tr);
      });
      window._l1Cache = rows;
    }catch(e){
      tbody.innerHTML = '<tr><td colspan="5" class="small" style="color:#b91c1c">'+(e.message||String(e))+'</td></tr>';
    }
  }
  $('#rLoadL1').addEventListener('click', ()=>loadL1ByKey($('#rInviter').value.trim()));
  $('#rExportL1').addEventListener('click', ()=> downloadCSV('referrals_L1.csv', window._l1Cache || []));

  async function buildTreeByKey(){
    const key = $('#treeUser').value.trim();
    const tbody = $('#treeTable tbody'); tbody.innerHTML = '<tr><td colspan="6" class="muted small">Загрузка…</td></tr>';
    if (!key){ tbody.innerHTML = '<tr><td colspan="6" class="muted small">Укажите User ID или реф-код</td></tr>'; return; }

    // resolve to user_id if ref_code given
    let rootId = key;
    if (!isUUID(key)){
      try{ const p = await sb.from('profiles').select('user_id').eq('ref_code', key).maybeSingle(); if (p?.data?.user_id) rootId = p.data.user_id; }catch(_){}
    }

    try{
      // collect up to 10 levels of referrals
      const ids = await getReferralsTree(rootId, 10);
      if (!ids.length){ tbody.innerHTML = '<tr><td colspan="6" class="muted small">Пусто</td></tr>'; window._treeCache=[]; return; }

      const prof = await sb.from('profiles').select('user_id,email,phone,ref_code').in('user_id', ids);
      const referrals = await sb.from('user_referrals').select('user_id, referrer_user_id').in('user_id', ids);
      // build map of level by tracing distance — simplest approach: do BFS locally again to determine level
      const levelMap = {};
      // BFS to compute levels
      const queue = [{id: rootId, level:0}];
      const childrenMap = {};
      (await sb.from('user_referrals').select('user_id,referrer_user_id').in('referrer_user_id', [rootId].concat(ids))).data?.forEach(r=>{
        childrenMap[r.referrer_user_id] = childrenMap[r.referrer_user_id]||[];
        childrenMap[r.referrer_user_id].push(r.user_id);
      });
      // Compute levels up to 10 by iterative traversal
      let cur = [rootId];
      for (let lvl=1; lvl<=10; lvl++){
        const next = [];
        for (const p of cur){
          const childs = childrenMap[p] || [];
          for (const c of childs){
            if (!levelMap[c]){
              levelMap[c] = lvl;
              next.push(c);
            }
          }
        }
        if (!next.length) break;
        cur = next;
      }
      const profilesById = {}; (prof.data||[]).forEach(p=>profilesById[p.user_id] = p);
      // fetch balances
      const w = await sb.from('wallets').select('user_id,balance_cents').in('user_id', ids);
      const balances = {}; (w.data||[]).forEach(x=>balances[x.user_id] = x.balance_cents||0);
      const rows = ids.map(uid=>({ level: levelMap[uid]||'—', user_id: uid, email: profilesById[uid]?.email||'', phone: profilesById[uid]?.phone||'', ref_code: profilesById[uid]?.ref_code||'', balance_cents: balances[uid]||0 }));
      tbody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>'+escapeHtml(String(r.level))+'</td>'
          + '<td class="nowrap">'+escapeHtml(r.user_id)+'</td>'
          + '<td>'+(r.email?escapeHtml(r.email):'—')+'</td>'
          + '<td>'+(r.phone?escapeHtml(r.phone):'—')+'</td>'
          + '<td class="right">'+fmtCents(r.balance_cents||0)+'</td>'
          + '<td>'+(r.ref_code?escapeHtml(r.ref_code):'—')+'</td>';
        tbody.appendChild(tr);
      });
      window._treeCache = rows;
    }catch(e){
      tbody.innerHTML = '<tr><td colspan="6" class="small" style="color:#b91c1c">'+(e.message||String(e))+'</td></tr>';
    }
  }
  $('#treeLoad').addEventListener('click', buildTreeByKey);
  $('#treeExport').addEventListener('click', ()=> downloadCSV('ref_tree.csv', (window._treeCache||[]).map(r=>({ level:r.level, user_id:r.user_id, email:r.email, phone:r.phone })) ));

  // ------------------ DRAWER ------------------
  $('#dClose').addEventListener('click', ()=>$('#drawer').classList.remove('open'));
  $('#dCopyUID').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText($('#dUserId').value); alert('Скопировано'); }catch(_){ alert('Скопируйте вручную'); }});

  async function openUserDrawer(uid){
    if (!uid) return;
    $('#drawer').classList.add('open'); $('#dTitle').textContent='Профиль: '+uid; $('#dUserId').value = uid;
    const [prof, wallet, wds, rrs] = await Promise.all([
      sb.from('profiles').select('user_id, created_at, email, phone, ref_code').eq('user_id', uid).maybeSingle(),
      sb.from('wallets').select('user_id, balance_cents').eq('user_id', uid).maybeSingle(),
      sb.from('withdrawals').select('created_at, amount_cents, status, txid').eq('user_id', uid).order('created_at', {ascending:false}).limit(20),
      sb.from('v_admin_rewards').select('created_at, level, amount_cents, amount_usd, reward_usdt, source_user_id, note, target_user_id').eq('target_user_id', uid).order('created_at', {ascending:false}).limit(300)
    ]);
    $('#dCreated').value = prof?.data?.created_at ? new Date(prof.data.created_at).toLocaleString() : '—';
    $('#dEmail').value = prof?.data?.email || '';
    $('#dPhone').value = prof?.data?.phone || '';
    $('#dBalance').value = ((wallet?.data?.balance_cents||0)/100).toFixed(2);
    $('#dRefCode').value = prof?.data?.ref_code || '';
    $('#dRefLink').value = prof?.data?.ref_code ? buildRefLink(prof.data.ref_code) : '';

    const wtbody = $('#dWTable tbody'); wtbody.innerHTML = '';
    (wds?.data||[]).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = '<td class="nowrap">'+new Date(r.created_at).toLocaleString()+'</td><td class="right">'+fmtCents(r.amount_cents||0)+'</td><td>'+escapeHtml(String(r.status||'pending'))+'</td><td class="nowrap">'+(r.txid?'<code>'+escapeHtml(short(r.txid))+'</code>':'—')+'</td>';
      wtbody.appendChild(tr);
    });

    const rtbody = $('#dRTable tbody'); rtbody.innerHTML = '';
    let dL1=0,dL2=0,dL3=0, dAll=0;
    (rrs?.data||[]).forEach(r=>{
      const amt = r.amount_cents ?? (r.amount_usd!=null?Math.round(Number(r.amount_usd)*100):(r.reward_usdt!=null?Math.round(Number(r.reward_usdt)*100):0));
      dAll += (amt||0);
      if (+r.level===1) dL1+=(amt||0);
      if (+r.level===2) dL2+=(amt||0);
      if (+r.level===3) dL3+=(amt||0);
      const tr = document.createElement('tr');
      tr.innerHTML = '<td class="nowrap">'+new Date(r.created_at).toLocaleString()+'</td><td>'+(r.level??'—')+'</td><td class="right">'+fmtCents(amt||0)+'</td><td class="nowrap">'+(r.source_user_id?escapeHtml(r.source_user_id):'—')+'</td>';
      rtbody.appendChild(tr);
    });
    $('#dRwAll').textContent = fmtCents(dAll);
    $('#dRwL1').textContent = fmtCents(dL1);
    $('#dRwL2').textContent = fmtCents(dL2);
    $('#dRwL3').textContent = fmtCents(dL3);

    $('#dCopyRef').onclick = async ()=>{ try{ await navigator.clipboard.writeText($('#dRefLink').value); alert('Скопировано'); }catch(_){ alert('Скопируйте вручную'); } };
    $('#dSaveProfile').onclick = async ()=>{ try{
      const upd = await sb.from('profiles').update({ email: $('#dEmail').value||null, phone: $('#dPhone').value||null, ref_code: $('#dRefCode').value||null }).eq('user_id', uid).select().maybeSingle();
      if (upd.error) throw upd.error;
      alert('Сохранено'); loadUsers();
    } catch(e){ alert(e.message || String(e)); } };

    const deltaRow = document.getElementById('deltaRow');
    if (hasAdjust && isAdmin) deltaRow.classList.remove('hidden'); else deltaRow.classList.add('hidden');
    $('#dApplyDelta').onclick = async ()=>{
      const delta = Number($('#dDelta').value || '0');
      if (!Number.isFinite(delta) || !delta) { alert('Введите число (USDT)'); return; }
      try{
        const r = await sb.rpc('admin_adjust_balance', { p_user_id: uid, p_delta_cents: toCents(delta) });
        if (r.error) throw r.error;
        alert('Баланс скорректирован'); openUserDrawer(uid); loadUsers();
      } catch(e){ alert(e.message || String(e)); }
    };
  }

  // ------------------ DEPOSITS ------------------
  let dRowsCache = [];
  async function loadDeposits(){
    if (!isAdmin) return;
    const tbody = $('#dTable tbody'); if(!tbody) return;
    tbody.innerHTML = '<tr><td colspan="7" class="muted small">Загрузка…</td></tr>';
    try {
      const r = await sb.from('v_admin_deposits').select('id, created_at, user_id, user_email, user_phone, amount_cents, currency, network, txid, status, note').order('created_at', {ascending:false}).limit(300);
      if (r.error){ tbody.innerHTML = '<tr><td colspan="7" class="err">'+(r.error.message||'error')+'</td></tr>'; return; }
      dRowsCache = r.data || [];
      const s = ($('#dSearch')?.value || '').toLowerCase().trim();
      let rows = dRowsCache;
      if (s){
        rows = rows.filter(x => (x.user_email||'').toLowerCase().includes(s) || (x.user_phone||'').toLowerCase().includes(s) || (x.txid||'').toLowerCase().includes(s) || (x.note||'').toLowerCase().includes(s) );
      }
      const fmtAmt = v => ((v||0)/100).toFixed(2) + ' USDT';
      const renderUser = x => (x.user_email||x.user_phone||x.user_id||'—');
      const renderTx = x => x.txid ? ('<a href="https://tronscan.org/#/transaction/'+escapeHtml(x.txid)+'" target="_blank">'+escapeHtml(x.txid.slice(0,10))+'…</a>') : '—';
      tbody.innerHTML = rows.map(x => `
        <tr>
          <td class="nowrap">${new Date(x.created_at).toLocaleString()}</td>
          <td>${escapeHtml(renderUser(x))}</td>
          <td>${escapeHtml((x.network||'')+' '+(x.currency||''))}</td>
          <td class="right">${fmtAmt(x.amount_cents)}</td>
          <td class="nowrap">${renderTx(x)}</td>
          <td>${escapeHtml(x.status||'')}</td>
          <td>${escapeHtml(x.note||'')}</td>
        </tr>`).join('');
      $('#dCount').textContent = String(rows.length);
      const sum = rows.reduce((a,x)=>a+(x.amount_cents||0),0);
      $('#dSum').textContent = ((sum||0)/100).toFixed(2) + ' USDT';
      $('#dUpdated').textContent = new Date().toLocaleString();
    } catch (err){
      tbody.innerHTML = '<tr><td colspan="7" class="small" style="color:#b91c1c">'+(err?.message||String(err))+'</td></tr>';
    }
  }
  $('#dRefresh').addEventListener('click', loadDeposits);
  $('#dExport').addEventListener('click', ()=> downloadCSV('deposits.csv', dRowsCache.map(r=>({ id:r.id, created_at:r.created_at, user_id:r.user_id, email:r.user_email, phone:r.user_phone, amount_cents:r.amount_cents, currency:r.currency, network:r.network, txid:r.txid, status:r.status, note:r.note })) ));
  $('#dSearch').addEventListener('input', loadDeposits);

  // ------------------ INIT ------------------
  function buildRefLink(code){ if(!code) return ''; try{ const url = new URL(location.origin + '/register_single.html'); url.searchParams.set('ref', code); return url.toString(); }catch(_){ return '/register_single.html?ref='+encodeURIComponent(code); } }

  (async function init(){
    await refreshAuth();
    await checkAdmin(); // uses admins table, no server-side current_setting
    await detectAdjust();
    if (!isAdmin) {
      // If not admin, but you want limited admins to access 'refs' tab only,
      // you can enable just that:
      // $$('#tabs .tab').forEach(b=>b.disabled=true); document.querySelector('[data-tab="refs"]').disabled=false;
      // For now, keep default: non-admins have tabs disabled.
    }
    // initial loads
    if (isAdmin) {
      loadWithdrawals(true);
      loadUsers();
      loadRewards();
      loadDeposits();
    }
    // realtime subscriptions (best-effort)
    try{ sb.channel('adm-rw').on('postgres_changes', { event:'*', schema:'public', table:'v_admin_rewards' }, ()=>{ if (activePage==='rewards') loadRewards(); }).subscribe(); }catch(_){}
    try{ sb.channel('adm-dep').on('postgres_changes', { event:'*', schema:'public', table:'deposits' }, ()=>{ if (activePage==='deposits') loadDeposits(); }).subscribe(); }catch(_){}
  })();

})();
</script>
</body>
</html>
